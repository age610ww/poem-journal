<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>每日诗词记录 · 主诗 + 随机复习</title>
  <style>
    :root{
      --page:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;

      --accent:#2563eb; /* 重点句颜色（仅文字色） */
      --danger:#ef4444;
      --good:#10b981;
      --warn:#f59e0b;

      --shadow: 0 10px 30px rgba(17,24,39,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI",
        "PingFang SC","Hiragino Sans GB","Microsoft YaHei", Arial;
      background: var(--page);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:26px auto;padding:0 16px;}
    .top{display:flex;gap:12px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap;margin-bottom:14px;}
    h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:13px;margin-top:6px;line-height:1.5}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .tab{
      border:1px solid var(--border);background:transparent;color:var(--text);
      padding:8px 10px;border-radius:10px;cursor:pointer;font-size:13px;
    }
    .tab.active{background:#eef2ff;border-color:#c7d2fe}
    .grid{display:grid;grid-template-columns: 1.25fr .75fr;gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      box-shadow: var(--shadow);
    }

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .col{display:flex;flex-direction:column;gap:10px;}
    .hr{height:1px;background:var(--border);margin:12px 0;}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      border:1px solid var(--border);background:#f9fafb;
      padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted);
    }

    .btn{
      background:#f3f4f6;border:1px solid #e5e7eb;color:var(--text);
      padding:10px 12px;border-radius:10px;cursor:pointer;font-size:14px;
    }
    .btn:hover{filter:brightness(0.98)}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff;}
    .btn.good{background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.35);}
    .btn.warn{background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.35);}
    .btn.danger{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35);}
    .btn.ghost{background:transparent}
    .btn.small{padding:6px 8px;font-size:12px;border-radius:9px}

    label{font-size:12px;color:var(--muted);}
    input[type="text"], textarea, select, input[type="date"]{
      background:#fff;color:var(--text);border:1px solid var(--border);
      border-radius:10px;padding:10px 12px;font-size:14px;outline:none;
    }
    textarea{width:100%;min-height:140px;resize:vertical;line-height:1.6}
    select{min-width:240px}

    .meta{color:var(--muted);font-size:13px;line-height:1.6}
    .notice{
      color:#92400e;background:rgba(245,158,11,.10);
      border:1px solid rgba(245,158,11,.25);
      padding:10px 12px;border-radius:12px;font-size:13px;line-height:1.6
    }

    .titleLine{display:flex;gap:10px;align-items:baseline;justify-content:space-between;flex-wrap:wrap}
    .titleLine h2{font-size:16px;margin:0;font-weight:750}
    .titleLine .sub2{font-size:12px;color:var(--muted)}

    /* ======== Poem Card ======== */
    .poemCard{
      background:#fff;
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      margin-top:10px;
    }
    .poemTitle{
      font-size:20px;
      font-weight:850;
      line-height:1.3;
      margin:0;
    }
    .poemMeta{
      margin-top:6px;
      color:var(--muted);
      font-size:12px;
      line-height:1.5;
    }
    .poemLines{ margin-top:10px; }
    .poemLine{
      padding:6px 2px;
      line-height:2.0;
      font-size:16px;
      letter-spacing:.2px;
      border-radius:10px;
    }
    /* 重点句：仅彩色+加粗，无底色 */
    .poemLine.highlight{
      color: var(--accent);
      font-weight: 800;
      background: transparent;
    }
    .poemActions{
      margin-top:12px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
      flex-wrap:wrap;
    }

    /* History */
    details{border:1px solid var(--border);border-radius:14px;background:#fff}
    summary{
      cursor:pointer; padding:12px;
      list-style:none;
      display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;
    }
    summary::-webkit-details-marker{display:none}
    .groupBody{padding:0 12px 12px}
    .miniRow{
      display:flex;gap:10px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;
      padding:10px 0;border-top:1px solid #f3f4f6
    }
    .miniRow:first-child{border-top:none}
    .miniRow .left{min-width:260px}
    .miniRow .right{display:flex;gap:8px;flex-wrap:wrap}
    .kbd{
      border:1px solid var(--border);background:#fff;padding:2px 6px;border-radius:8px;
      font-size:12px;color:var(--muted)
    }

    /* Modal */
    .modalMask{
      position:fixed;inset:0;background:rgba(17,24,39,.45);
      display:none;align-items:center;justify-content:center;padding:18px;
    }
    .modal{
      width:min(900px, 100%);
      background:#fff;
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      box-shadow:0 20px 60px rgba(17,24,39,.20);
    }
    .split{display:grid;grid-template-columns: 1fr 1fr;gap:12px;}
    @media (max-width: 980px){ .split{grid-template-columns:1fr;} }

    .linePicker{
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      padding:10px;
      max-height:320px;
      overflow:auto;
    }
    .pickLine{
      padding:8px 10px;border-radius:12px;cursor:pointer;
      border:1px solid transparent; line-height:1.6;
      display:flex;gap:10px;
    }
    .pickLine:hover{background:#f9fafb}
    .pickLine.active{
      border-color:rgba(37,99,235,.30);
      color: var(--accent);
      font-weight: 800;
    }
    .footNote{font-size:12px;color:var(--muted);line-height:1.6}

    .switch{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border:1px solid var(--border);border-radius:12px;
      background:#fff;color:var(--muted);font-size:13px;
    }
    .switch input{transform:scale(1.1)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>每日诗词记录</h1>
        <div class="sub">记录保存在当前设备/浏览器的本地存储；建议定期导出 JSON 备份。</div>
      </div>
      <div class="tabs">
        <button class="tab active" id="tabToday">今日</button>
        <button class="tab" id="tabHistory">历史</button>
        <button class="tab" id="tabBackup">备份</button>
        <button class="btn primary" id="btnAddTop">+ 记录诗词</button>
      </div>
    </div>

    <div class="grid">
      <div class="card" id="leftCard"></div>
      <div class="card" id="rightCard"></div>
    </div>
  </div>

  <!-- 新增/编辑 Modal -->
  <div class="modalMask" id="modalMask" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="titleLine">
        <h2 id="modalTitle">记录诗词</h2>
        <div class="row">
          <button class="btn ghost small" id="btnCloseModal">关闭</button>
        </div>
      </div>
      <div class="hr"></div>

      <div class="split">
        <div class="col">
          <div class="row">
            <div style="flex:1">
              <label>日期（默认今天，可改）</label>
              <input type="date" id="fDate" />
            </div>
            <div style="flex:1">
              <label>题目（必填，用于全库查重）</label>
              <input type="text" id="fTitle" placeholder="如：静夜思" />
            </div>
          </div>

          <div class="row">
            <div style="flex:1">
              <label>作者（可选）</label>
              <input type="text" id="fAuthor" placeholder="如：李白" />
            </div>
            <div style="flex:1">
              <label>朝代（可选）</label>
              <input type="text" id="fDynasty" placeholder="如：唐" />
            </div>
          </div>

          <div class="row" style="justify-content:space-between">
            <div class="switch">
              <input type="checkbox" id="fSetAsMain" />
              <label for="fSetAsMain" style="margin:0;cursor:pointer">设为当日主诗</label>
            </div>
            <div class="meta">主诗可指向历史记录（不必是当天新记录）。</div>
          </div>

          <div>
            <label>诗词正文（整首，建议每行一句；粘贴即可）</label>
            <textarea id="fPoem" placeholder="床前明月光&#10;疑是地上霜&#10;举头望明月&#10;低头思故乡"></textarea>
            <div class="footNote">会自动去掉空行。重点句仅“彩色+加粗”，不加底色。</div>
          </div>

          <div>
            <label>备注（可选）</label>
            <input type="text" id="fNote" placeholder="如：今天卡在第二句 / 想重点复习第三句" />
          </div>

          <div class="row" style="justify-content:flex-end">
            <button class="btn danger" id="btnDeleteInModal" style="display:none">删除</button>
            <button class="btn primary" id="btnSave">保存</button>
          </div>
        </div>

        <div>
          <div class="row" style="justify-content:space-between">
            <div class="pill">选择重点句（可多选）</div>
            <div class="meta">已选 <span id="selCount">0</span> 行（至少 1 行）</div>
          </div>
          <div class="linePicker" id="linePicker">
            <div class="meta">先在左侧输入正文，这里会出现逐行预览。</div>
          </div>
          <div class="row" style="justify-content:flex-end;margin-top:10px">
            <button class="btn small ghost" id="btnClearSel">清空选择</button>
            <button class="btn small ghost" id="btnSelectAll">全选</button>
          </div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="footNote">
        说明：只记录诗词（整首 + 若干重点句）。全库按“题目”去重；若重复可选择编辑旧记录或直接设为当日主诗。
      </div>
    </div>
  </div>

<script>
/** =========================
 *  Storage & schema
 * ========================= */
const LS_KEY = "poem_journal_v2"; // 当前版本 key（会自动从 v1 迁移）

function nowTs(){ return Date.now(); }
function pad2(n){ return String(n).padStart(2,"0"); }
function dateKey(d=new Date()){
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}
function yesterdayKey(){
  const d = new Date();
  d.setDate(d.getDate() - 1);
  return dateKey(d);
}
function uuid(){
  if(window.crypto && crypto.randomUUID) return crypto.randomUUID();
  return `id_${Math.random().toString(16).slice(2)}_${Date.now()}`;
}
function safeLines(lines){
  return (Array.isArray(lines)? lines : [])
    .map(x => String(x||"").trim())
    .filter(x => x.length > 0);
}
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function normTitle(t){
  return String(t || "").trim().replace(/\s+/g, " ");
}

function migrateDB(db){
  db.version = db.version || 3;
  db.ui = db.ui || {};
  db.ui.activeTab = db.ui.activeTab || "today";
  db.ui.selectedDate = db.ui.selectedDate || yesterdayKey();
  db.ui.selectedRecordByDate = db.ui.selectedRecordByDate || {};
  db.ui.mainByDate = db.ui.mainByDate || {};
  db.ui.historyQuery = db.ui.historyQuery || "";
  db.ui.reviewRandomId = db.ui.reviewRandomId || null;

  let changed = false;

  for(const r of db.records){
    if(!r.id){ r.id = uuid(); changed = true; }
    r.createdDate = r.createdDate || dateKey();
    r.createdAt = r.createdAt || nowTs();
    r.updatedAt = r.updatedAt || r.createdAt;

    // poem lines
    r.poemLines = safeLines(r.poemLines || []);
    if(r.poemLines.length === 0){ r.poemLines = [""]; changed = true; }

    // highlight indices (兼容旧字段 highlightIndex)
    if(!Array.isArray(r.highlightIndices)){
      if(Number.isInteger(r.highlightIndex)) r.highlightIndices = [r.highlightIndex];
      else r.highlightIndices = [0];
      changed = true;
    }
    const maxIdx = Math.max(0, r.poemLines.length - 1);
    r.highlightIndices = Array.from(new Set(
      (r.highlightIndices || []).map(x => parseInt(x,10)).filter(x => Number.isFinite(x))
    )).map(x => Math.max(0, Math.min(maxIdx, x))).sort((a,b)=>a-b);
    if(r.highlightIndices.length === 0){ r.highlightIndices = [0]; changed = true; }

    // review fields
    if(r.lastReviewedAt === undefined){ r.lastReviewedAt = null; changed = true; }
    if(r.reviewCount === undefined){ r.reviewCount = 0; changed = true; }
    if(r.nextDueAt === undefined){ r.nextDueAt = null; changed = true; }

    // normalize title storage (不强制改变原值，只在保存时强制)
  }

  if(changed) localStorage.setItem(LS_KEY, JSON.stringify(db));
  return db;
}

function loadDB(){
  // Prefer v2
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(raw){
      const db = JSON.parse(raw);
      if(db && Array.isArray(db.records)) return migrateDB(db);
    }
  }catch(e){}

  // Fallback migrate from v1 if exists
  try{
    const raw1 = localStorage.getItem("poem_journal_v1");
    if(raw1){
      const old = JSON.parse(raw1);
      if(old && Array.isArray(old.records)){
        const db = { version:3, records: old.records, ui: old.ui || {} };
        const migrated = migrateDB(db);
        localStorage.setItem(LS_KEY, JSON.stringify(migrated));
        return migrated;
      }
    }
  }catch(e){}

  return migrateDB({ version:3, records:[], ui:{} });
}

function saveDB(db){
  localStorage.setItem(LS_KEY, JSON.stringify(db));
}

let db = loadDB();

/** =========================
 *  Review scheduling
 * ========================= */
const REVIEW_INTERVAL_DAYS = [1,3,7,14,30,60,120];
function nextDueFrom(count, fromTs){
  const idx = Math.max(0, Math.min(REVIEW_INTERVAL_DAYS.length-1, count-1));
  return fromTs + REVIEW_INTERVAL_DAYS[idx]*24*60*60*1000;
}
function isDue(rec, now=nowTs()){
  if(rec.nextDueAt != null) return now >= rec.nextDueAt;
  if(!rec.lastReviewedAt) return true;
  if(!rec.reviewCount || rec.reviewCount <= 0) return now >= (rec.lastReviewedAt + 24*60*60*1000);
  return now >= nextDueFrom(rec.reviewCount, rec.lastReviewedAt);
}
function markKnow(recId){
  const rec = db.records.find(r => r.id === recId);
  if(!rec) return;
  const t = nowTs();
  rec.reviewCount = (rec.reviewCount || 0) + 1;
  rec.lastReviewedAt = t;
  rec.nextDueAt = nextDueFrom(rec.reviewCount, t);
  rec.updatedAt = t;
  saveDB(db);
  render();
}
function markAgain(recId){
  const rec = db.records.find(r => r.id === recId);
  if(!rec) return;
  const t = nowTs();
  rec.lastReviewedAt = t;
  rec.nextDueAt = t + 24*60*60*1000;
  rec.updatedAt = t;
  saveDB(db);
  render();
}

/** =========================
 *  Helpers
 * ========================= */
function recTitle(rec){
  const t = rec.title?.trim();
  const a = rec.author?.trim();
  const d = rec.dynasty?.trim();
  const left = t ? `《${t}》` : "（未命名）";
  const right = [d,a].filter(Boolean).join("·");
  return right ? `${left} · ${right}` : left;
}
function daysAgo(ts){
  if(!ts) return "未复习过";
  const now = new Date();
  const d = new Date(ts);
  const n0 = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
  const d0 = new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime();
  const diff = Math.round((n0 - d0) / (24*60*60*1000));
  if(diff <= 0) return "今天";
  if(diff === 1) return "1 天前";
  return `${diff} 天前`;
}
function groupByDate(records){
  const map = new Map();
  for(const r of records){
    const k = r.createdDate || "未知日期";
    if(!map.has(k)) map.set(k, []);
    map.get(k).push(r);
  }
  for(const [k, arr] of map.entries()){
    arr.sort((a,b) => (b.createdAt||0) - (a.createdAt||0));
  }
  const keys = Array.from(map.keys()).sort((a,b) => (a<b?1:-1));
  return { keys, map };
}
function getRecordsByDate(d){
  return db.records
    .filter(r => r.createdDate === d)
    .sort((a,b) => (b.createdAt||0)-(a.createdAt||0));
}
function setMainForDate(d, recId){
  db.ui.mainByDate = db.ui.mainByDate || {};
  db.ui.mainByDate[d] = recId;
  saveDB(db);
}
function getMainRecordForDate(d){
  const recs = getRecordsByDate(d);

  const mainId = db.ui.mainByDate?.[d] || null;
  const main = mainId ? db.records.find(r => r.id === mainId) : null; // 允许主诗来自历史

  const selectedId = db.ui.selectedRecordByDate?.[d] || null;
  const selected = selectedId ? db.records.find(r => r.id === selectedId) : null;

  // 优先：已选择 > 主诗 > 当天最新
  const active = selected || main || recs[0] || null;

  // 下拉可选项：主诗（若存在） + 当天记录
  const options = [];
  const seen = new Set();
  if(main){ options.push(main); seen.add(main.id); }
  for(const r of recs){
    if(!seen.has(r.id)){ options.push(r); seen.add(r.id); }
  }
  return { recs, main, active, options };
}
function chooseRandom(arr, excludeId=null){
  if(!arr || arr.length === 0) return null;
  if(arr.length === 1) return arr[0];
  const candidates = excludeId ? arr.filter(x => x.id !== excludeId) : arr.slice();
  const pool = candidates.length ? candidates : arr;
  return pool[Math.floor(Math.random() * pool.length)];
}

/** =========================
 *  UI: Tabs
 * ========================= */
const left = document.getElementById("leftCard");
const right = document.getElementById("rightCard");

const tabToday = document.getElementById("tabToday");
const tabHistory = document.getElementById("tabHistory");
const tabBackup = document.getElementById("tabBackup");

let activeTab = db.ui.activeTab || "today";
tabToday.onclick = () => { activeTab="today"; persistUI(); render(); };
tabHistory.onclick = () => { activeTab="history"; persistUI(); render(); };
tabBackup.onclick = () => { activeTab="backup"; persistUI(); render(); };

function persistUI(){ db.ui.activeTab = activeTab; saveDB(db); }
function setActiveTab(){
  [tabToday, tabHistory, tabBackup].forEach(x => x.classList.remove("active"));
  if(activeTab==="today") tabToday.classList.add("active");
  if(activeTab==="history") tabHistory.classList.add("active");
  if(activeTab==="backup") tabBackup.classList.add("active");
}

/** =========================
 *  Modal: Add/Edit
 * ========================= */
const modalMask = document.getElementById("modalMask");
const btnAddTop = document.getElementById("btnAddTop");
const btnCloseModal = document.getElementById("btnCloseModal");
const modalTitle = document.getElementById("modalTitle");
const btnSave = document.getElementById("btnSave");
const btnDeleteInModal = document.getElementById("btnDeleteInModal");

const fDate = document.getElementById("fDate");
const fTitle = document.getElementById("fTitle");
const fAuthor = document.getElementById("fAuthor");
const fDynasty = document.getElementById("fDynasty");
const fPoem = document.getElementById("fPoem");
const fNote = document.getElementById("fNote");
const fSetAsMain = document.getElementById("fSetAsMain");

const linePicker = document.getElementById("linePicker");
const selCount = document.getElementById("selCount");
const btnClearSel = document.getElementById("btnClearSel");
const btnSelectAll = document.getElementById("btnSelectAll");

let modalMode = "add";
let editingId = null;
let editingOriginalDate = null;
let selectedHighlights = new Set();

btnAddTop.onclick = () => openAddModal();
btnCloseModal.onclick = () => closeModal();
modalMask.addEventListener("click", (e) => { if(e.target === modalMask) closeModal(); });

fPoem.addEventListener("input", () => renderLinePicker());
btnClearSel.onclick = () => { selectedHighlights = new Set(); renderLinePicker(); };
btnSelectAll.onclick = () => {
  const lines = safeLines(fPoem.value.split("\n"));
  selectedHighlights = new Set(lines.map((_,i)=>i));
  renderLinePicker();
};

function openAddModal(){
  modalMode = "add";
  editingId = null;
  editingOriginalDate = null;

  modalTitle.textContent = "记录诗词";
  btnDeleteInModal.style.display = "none";

  fDate.value = dateKey();
  fTitle.value = "";
  fAuthor.value = "";
  fDynasty.value = "";
  fPoem.value = "";
  fNote.value = "";
  fSetAsMain.checked = true;

  selectedHighlights = new Set([0]);
  renderLinePicker();
  modalMask.style.display = "flex";
}
function openEditModal(recId){
  const rec = db.records.find(r => r.id === recId);
  if(!rec) return;

  modalMode = "edit";
  editingId = recId;
  editingOriginalDate = rec.createdDate || null;

  modalTitle.textContent = "编辑记录";
  btnDeleteInModal.style.display = "inline-block";

  fDate.value = rec.createdDate || dateKey();
  fTitle.value = rec.title || "";
  fAuthor.value = rec.author || "";
  fDynasty.value = rec.dynasty || "";
  fPoem.value = safeLines(rec.poemLines).join("\n");
  fNote.value = rec.note || "";

  selectedHighlights = new Set(rec.highlightIndices || [0]);

  const d = rec.createdDate || dateKey();
  fSetAsMain.checked = (db.ui.mainByDate && db.ui.mainByDate[d] === rec.id) ? true : false;

  renderLinePicker();
  modalMask.style.display = "flex";
}
function closeModal(){ modalMask.style.display = "none"; }

function renderLinePicker(){
  const lines = safeLines(fPoem.value.split("\n"));
  if(lines.length === 0){
    linePicker.innerHTML = `<div class="meta">先在左侧输入正文，这里会出现逐行预览。</div>`;
    selCount.textContent = "0";
    return;
  }
  const maxIdx = lines.length - 1;
  selectedHighlights = new Set(Array.from(selectedHighlights).map(i => Math.max(0, Math.min(maxIdx, i))));
  if(selectedHighlights.size === 0) selectedHighlights.add(0);
  selCount.textContent = String(selectedHighlights.size);

  linePicker.innerHTML = lines.map((ln, idx) => {
    const active = selectedHighlights.has(idx) ? "active" : "";
    return `
      <div class="pickLine ${active}" data-idx="${idx}">
        <div style="width:28px;color:#9ca3af;font-size:12px">${idx+1}</div>
        <div style="flex:1">${escapeHtml(ln)}</div>
      </div>
    `;
  }).join("");

  linePicker.querySelectorAll(".pickLine").forEach(el => {
    el.onclick = () => {
      const idx = parseInt(el.getAttribute("data-idx"), 10);
      if(selectedHighlights.has(idx)) selectedHighlights.delete(idx);
      else selectedHighlights.add(idx);
      if(selectedHighlights.size === 0) selectedHighlights.add(idx);
      renderLinePicker();
    };
  });
}

btnSave.onclick = () => {
  const d = fDate.value || dateKey();

  // 题目必填（用于全库去重）
  const titleNow = normTitle(fTitle.value);
  if(!titleNow){
    alert("请填写题目（用于全库查重，避免重复记录）。");
    return;
  }

  const poemLines = safeLines(fPoem.value.split("\n"));
  if(poemLines.length === 0){
    alert("请先输入诗词正文（至少一行）。");
    return;
  }

  const maxIdx = poemLines.length - 1;
  const highlightIndices = Array.from(selectedHighlights)
    .map(i => parseInt(i,10))
    .filter(i => Number.isFinite(i))
    .map(i => Math.max(0, Math.min(maxIdx, i)))
    .sort((a,b)=>a-b);

  if(highlightIndices.length === 0){
    alert("请至少选择 1 行作为重点句。");
    return;
  }

  const payload = {
    createdDate: d,
    title: titleNow, // 强制使用归一化标题
    author: String(fAuthor.value || "").trim() || null,
    dynasty: String(fDynasty.value || "").trim() || null,
    poemLines,
    highlightIndices,
    note: String(fNote.value || "").trim() || null,
  };

  if(modalMode === "add"){
    // ===== 全库按题目去重（不允许新增重复） =====
    const dup = db.records.find(r => normTitle(r.title) === titleNow);
    if(dup){
      const goEdit = confirm(
        `检测到历史中已存在同题目记录：《${titleNow}》\n` +
        `原记录日期：${dup.createdDate || "未知"}\n\n` +
        `点击“确定”：去编辑那条旧记录（不会新增）。\n` +
        `点击“取消”：继续下一步。`
      );
      if(goEdit){
        closeModal();
        openEditModal(dup.id);
        return;
      }

      const setMain = confirm(
        `是否将“已有的《${titleNow}》”设为 ${d} 的主诗？\n` +
        `（不新增记录，只设置主诗指向）\n\n` +
        `点击“确定”：设为主诗\n` +
        `点击“取消”：返回继续修改（不保存）`
      );
      if(setMain){
        setMainForDate(d, dup.id);
        db.ui.selectedDate = d;
        db.ui.selectedRecordByDate[d] = dup.id; // 让主界面直接显示这首
        saveDB(db);
        closeModal();
        render();
      }
      return;
    }
    // ===== 去重结束 =====

    const rec = {
      id: uuid(),
      ...payload,
      createdAt: nowTs(),
      updatedAt: nowTs(),
      lastReviewedAt: null,
      reviewCount: 0,
      nextDueAt: null
    };
    db.records.unshift(rec);

    if(fSetAsMain.checked){
      setMainForDate(d, rec.id);
    }

    db.ui.selectedDate = d;
    db.ui.selectedRecordByDate[d] = rec.id;

    saveDB(db);
    closeModal();
    render();
    return;
  }

  // Edit mode
  if(modalMode === "edit" && editingId){
    const rec = db.records.find(r => r.id === editingId);
    if(!rec) return;

    // 编辑时也防止把题目改成别人已有的题目
    const conflict = db.records.find(r => r.id !== rec.id && normTitle(r.title) === titleNow);
    if(conflict){
      const goEdit = confirm(
        `题目《${titleNow}》已存在另一条记录（日期：${conflict.createdDate || "未知"}）。\n\n` +
        `点击“确定”：去编辑那条已有记录。\n` +
        `点击“取消”：返回继续修改（不保存）。`
      );
      if(goEdit){
        closeModal();
        openEditModal(conflict.id);
      }
      return;
    }

    const oldDate = editingOriginalDate || rec.createdDate;

    Object.assign(rec, payload);
    rec.updatedAt = nowTs();

    // 若记录从 oldDate 改到新日期，且曾是 oldDate 主诗，则清除 oldDate 主诗
    if(oldDate && oldDate !== d && db.ui.mainByDate && db.ui.mainByDate[oldDate] === rec.id){
      delete db.ui.mainByDate[oldDate];
    }

    // 设置/取消当前日期主诗
    if(fSetAsMain.checked){
      setMainForDate(d, rec.id);
    }else{
      if(db.ui.mainByDate && db.ui.mainByDate[d] === rec.id){
        delete db.ui.mainByDate[d];
      }
    }

    db.ui.selectedDate = d;
    db.ui.selectedRecordByDate[d] = rec.id;

    saveDB(db);
    closeModal();
    render();
  }
};

btnDeleteInModal.onclick = () => {
  if(!editingId) return;
  const ok = confirm("确定删除这条记录？删除后无法恢复（除非你有备份）。");
  if(!ok) return;

  const rec = db.records.find(r => r.id === editingId);
  if(rec && db.ui.mainByDate && db.ui.mainByDate[rec.createdDate] === rec.id){
    delete db.ui.mainByDate[rec.createdDate];
  }
  if(db.ui.reviewRandomId === editingId) db.ui.reviewRandomId = null;

  db.records = db.records.filter(r => r.id !== editingId);
  saveDB(db);
  closeModal();
  render();
};

/** =========================
 *  Rendering blocks
 * ========================= */
function renderPoemCard(rec, actionsHtml){
  const lines = safeLines(rec.poemLines);
  const set = new Set(rec.highlightIndices || []);
  const title = recTitle(rec);
  const meta = [
    rec.createdDate ? `记录日期：${rec.createdDate}` : null,
    `上次复习：${rec.lastReviewedAt ? daysAgo(rec.lastReviewedAt) : "未复习过"}`,
    `复习次数：${rec.reviewCount || 0}`
  ].filter(Boolean).join(" · ");

  return `
    <div class="poemCard">
      <div class="poemTitle">${escapeHtml(title)}</div>
      <div class="poemMeta">${escapeHtml(meta)}</div>
      <div class="poemLines">
        ${lines.map((ln,i)=> `<div class="poemLine ${set.has(i)?"highlight":""}">${escapeHtml(ln)}</div>`).join("")}
      </div>
      ${rec.note ? `<div class="poemMeta" style="margin-top:8px">备注：${escapeHtml(rec.note)}</div>` : ``}
      <div class="poemActions">
        ${actionsHtml || ""}
      </div>
    </div>
  `;
}

/** =========================
 *  Today view
 * ========================= */
function renderToday(){
  db.ui.selectedDate = db.ui.selectedDate || yesterdayKey();
  const selectedDate = db.ui.selectedDate;

  const { recs, main, active, options } = getMainRecordForDate(selectedDate);

  // 复习池：优先到期，否则全库
  const now = nowTs();
  const duePool = db.records.filter(r => isDue(r, now));
  const pool = duePool.length ? duePool : db.records.slice();

  // 维护当前随机复习记录（如果不存在/不在池里，则重抽）
  let reviewRec = null;
  if(pool.length){
    const currentId = db.ui.reviewRandomId;
    reviewRec = currentId ? pool.find(r => r.id === currentId) : null;
    if(!reviewRec){
      reviewRec = chooseRandom(pool);
      db.ui.reviewRandomId = reviewRec ? reviewRec.id : null;
      saveDB(db);
    }
  }else{
    db.ui.reviewRandomId = null;
    saveDB(db);
  }

  // Left: 主诗/当日显示
  left.innerHTML = `
    <div class="titleLine">
      <h2>当日主诗</h2>
      <div class="sub2">选日期查看；主诗可指向历史记录</div>
    </div>

    <div class="hr"></div>

    <div class="row" style="justify-content:space-between">
      <div class="row">
        <label>日期：</label>
        <input type="date" id="mainDate" value="${escapeHtml(selectedDate)}" />
      </div>
      <div class="pill">该日新记录：${recs.length} 条</div>
    </div>

    ${(!active) ? `
      <div class="notice" style="margin-top:10px">
        该日期没有可显示的诗（既没有新记录，也未设置主诗）。你可以新增一条，或把历史诗设为该日主诗。
      </div>
    ` : `
      ${(options.length > 1) ? `
        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <label>查看：</label>
          <select id="selRecord"></select>
        </div>
      ` : ``}

      ${renderPoemCard(active, `
        <button class="btn small good" id="btnMainKnow">已会</button>
        <button class="btn small warn" id="btnMainAgain">再来</button>
        <button class="btn small ghost" id="btnMainEdit">编辑</button>
      `)}
    `}
  `;

  // Right: 随机复习
  right.innerHTML = `
    <div class="titleLine">
      <h2>随机复习</h2>
      <div class="sub2">每次只显示 1 首</div>
    </div>

    <div class="hr"></div>

    <div class="row" style="justify-content:flex-end">
      <button class="btn small primary" id="btnReroll">随机换一首</button>
    </div>

    ${(!reviewRec) ? `
      <div class="meta" style="margin-top:10px">还没有可复习的诗。先新增几条记录。</div>
    ` : `
      ${renderPoemCard(reviewRec, `
        <button class="btn small good" data-ract="know" data-id="${reviewRec.id}">已会</button>
        <button class="btn small warn" data-ract="again" data-id="${reviewRec.id}">再来</button>
        <button class="btn small ghost" data-ract="edit" data-id="${reviewRec.id}">编辑</button>
      `)}
    `}

    <div class="hr"></div>
    <div class="pill">保存位置</div>
    <div class="meta">
      内容保存于 <b>当前设备 + 当前浏览器</b>。换设备/换浏览器不会自动同步。建议定期去“备份”导出 JSON。
    </div>
  `;

  // Bind: date selector
  document.getElementById("mainDate").onchange = (e) => {
    db.ui.selectedDate = e.target.value || db.ui.selectedDate;
    saveDB(db);
    render();
  };

  // Bind: record selector (options)
  if(active && options.length > 1){
    const sel = document.getElementById("selRecord");
    const mainId = db.ui.mainByDate?.[selectedDate] || null;

    sel.innerHTML = options.map((r, i) => {
      const isMain = (mainId && r.id === mainId);
      const tag = isMain ? "（主诗）" : (r.createdDate === selectedDate ? "（当天）" : "（历史）");
      return `<option value="${r.id}" ${r.id===active.id?"selected":""}>${i+1}. ${escapeHtml(recTitle(r))} ${tag}</option>`;
    }).join("");

    sel.onchange = () => {
      db.ui.selectedRecordByDate[selectedDate] = sel.value;
      saveDB(db);
      render();
    };
  }

  // Bind: main actions
  if(active){
    document.getElementById("btnMainKnow").onclick = () => markKnow(active.id);
    document.getElementById("btnMainAgain").onclick = () => markAgain(active.id);
    document.getElementById("btnMainEdit").onclick = () => openEditModal(active.id);
  }

  // Bind: reroll
  document.getElementById("btnReroll").onclick = () => {
    const now = nowTs();
    const duePool = db.records.filter(r => isDue(r, now));
    const pool = duePool.length ? duePool : db.records.slice();
    const next = chooseRandom(pool, db.ui.reviewRandomId);
    db.ui.reviewRandomId = next ? next.id : null;
    saveDB(db);
    render();
  };

  // Bind: review actions
  right.querySelectorAll("button[data-ract]").forEach(btn => {
    btn.onclick = () => {
      const act = btn.getAttribute("data-ract");
      const id = btn.getAttribute("data-id");
      if(act==="know") return markKnow(id);
      if(act==="again") return markAgain(id);
      if(act==="edit") return openEditModal(id);
    };
  });
}

/** =========================
 *  History view
 * ========================= */
let historyQuery = db.ui.historyQuery || "";

function renderMiniRow(rec){
  const reviewed = rec.lastReviewedAt ? daysAgo(rec.lastReviewedAt) : "未复习过";
  return `
    <div class="miniRow">
      <div class="left">
        <div style="font-weight:750">${escapeHtml(recTitle(rec))}</div>
        <div class="meta">记录日期：${escapeHtml(rec.createdDate || "")}</div>
        <div class="meta">上次复习：${escapeHtml(reviewed)} · 复习次数：${rec.reviewCount||0}</div>
        <div id="full_${rec.id}" style="display:none;margin-top:8px">
          ${renderPoemCard(rec, `
            <button class="btn small good" data-hact="know" data-id="${rec.id}">已会</button>
            <button class="btn small warn" data-hact="again" data-id="${rec.id}">再来</button>
            <button class="btn small ghost" data-hact="edit" data-id="${rec.id}">编辑</button>
            <button class="btn small danger" data-hact="del" data-id="${rec.id}">删除</button>
          `)}
        </div>
      </div>
      <div class="right">
        <button class="btn small ghost" data-hact="toggle" data-id="${rec.id}">展开/收起</button>
      </div>
    </div>
  `;
}

function renderDateGroup(dateStr, recs){
  const today = dateKey();
  const d = new Date(dateStr+"T00:00:00");
  const t = new Date(today+"T00:00:00");
  const diffDays = Math.round((t.getTime() - d.getTime())/(24*60*60*1000));
  const open = (diffDays >= 0 && diffDays <= 2);
  return `
    <details ${open ? "open" : ""}>
      <summary>
        <div class="row">
          <div class="pill">${escapeHtml(dateStr)}</div>
          <div class="meta">共 ${recs.length} 条</div>
        </div>
        <div class="meta">点击展开/折叠</div>
      </summary>
      <div class="groupBody">
        ${recs.map(r => renderMiniRow(r)).join("")}
      </div>
    </details>
  `;
}

function renderHistory(){
  const total = db.records.length;
  const q = String(historyQuery || "").trim();

  const filtered = q ? db.records.filter(r => {
    const hay = [
      r.createdDate,
      r.title, r.author, r.dynasty,
      ...(safeLines(r.poemLines)),
      r.note
    ].filter(Boolean).join("\n");
    return hay.toLowerCase().includes(q.toLowerCase());
  }) : db.records.slice();

  const { keys, map } = groupByDate(filtered);

  left.innerHTML = `
    <div class="titleLine">
      <h2>历史记录</h2>
      <div class="sub2">共 ${total} 条${q ? ` · 匹配 ${filtered.length} 条` : ""}</div>
    </div>

    <div class="hr"></div>

    <div class="row">
      <input type="text" id="historySearch" placeholder="搜索：题目 / 作者 / 正文关键词 / 备注"
        value="${escapeHtml(q)}" style="flex:1;min-width:260px" />
      <button class="btn ghost" id="btnClearSearch">清空</button>
    </div>

    <div class="hr"></div>

    ${keys.length===0 ? `
      <div class="meta">没有记录。点击右上角 <span class="kbd">+ 记录诗词</span> 添加第一条。</div>
    ` : `
      <div c
