<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>每日诗词记录 · 主诗 + 随机复习</title>
  <style>
    :root{
      --page:#ffffff;

      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;

      --accent:#2563eb;
      --accent-soft: rgba(37,99,235,.10);

      --good:#10b981;
      --warn:#f59e0b;
      --danger:#ef4444;

      --radius-lg:18px;
      --radius-md:14px;
      --radius-sm:12px;

      --shadow-sm: 0 6px 18px rgba(17,24,39,.06);
      --shadow-md: 0 14px 36px rgba(17,24,39,.10);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--page);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI",
        "PingFang SC","Hiragino Sans GB","Microsoft YaHei", Arial;
      letter-spacing: .1px;
    }

    .topbar{
      position:sticky;
      top:0;
      z-index:10;
      background:rgba(255,255,255,.92);
      border-bottom:1px solid rgba(229,231,235,.75);
    }
    .topbar-inner{
      max-width:1120px;
      margin:0 auto;
      padding:14px 16px;
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:240px;
    }
    .brand h1{
      margin:0;
      font-size:18px;
      font-weight:800;
      letter-spacing:.3px;
    }
    .brand .sub{
      margin:0;
      color:var(--muted);
      font-size:12px;
      line-height:1.5;
    }

    .tabs{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .seg{
      display:flex;
      gap:0;
      border:1px solid var(--border);
      border-radius:999px;
      overflow:hidden;
      background:#fff;
      box-shadow: var(--shadow-sm);
    }
    .tab{
      border:none;
      background:transparent;
      color:var(--muted);
      padding:10px 14px;
      cursor:pointer;
      font-size:13px;
      font-weight:650;
      transition: background .18s ease, color .18s ease;
      outline:none;
    }
    .tab:hover{background:rgba(17,24,39,.03); color:var(--text);}
    .tab.active{
      background:var(--accent-soft);
      color:var(--accent);
    }

    .btn{
      appearance:none;
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-size:14px;
      font-weight:650;
      transition: transform .06s ease, box-shadow .18s ease, background .18s ease;
      box-shadow: var(--shadow-sm);
    }
    .btn:hover{ box-shadow: var(--shadow-md); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: rgba(37,99,235,.35);
      background: linear-gradient(180deg, rgba(37,99,235,.95), rgba(37,99,235,.85));
      color:#fff;
    }
    .btn.ghost{
      background:transparent;
      box-shadow:none;
    }
    .btn.small{
      padding:7px 10px;
      font-size:12px;
      border-radius:10px;
      box-shadow:none;
    }
    .btn.good{ border-color: rgba(16,185,129,.35); background: rgba(16,185,129,.10); box-shadow:none; }
    .btn.warn{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); box-shadow:none; }
    .btn.danger{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); box-shadow:none; }

    .wrap{
      max-width:1120px;
      margin:18px auto 34px;
      padding:0 16px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.35fr .65fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr;}
    }

    .card{
      background:#fff;
      border:1px solid rgba(229,231,235,.9);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      padding:14px;
    }
    .cardHead{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      padding:2px 2px 10px;
    }
    .cardHead h2{
      margin:0;
      font-size:16px;
      font-weight:850;
    }
    .cardHead .sub2{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }
    .hr{
      height:1px;
      background: rgba(229,231,235,.9);
      margin:12px 0;
    }
    .row suggesting{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .col{display:flex;flex-direction:column;gap:10px;}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border:1px solid rgba(229,231,235,.95);
      border-radius:999px;
      background: rgba(17,24,39,.02);
      font-size:12px;
      color:var(--muted);
      font-weight:650;
    }
    .meta{color:var(--muted);font-size:13px;line-height:1.7}
    .notice{
      color:#92400e;
      background:rgba(245,158,11,.10);
      border:1px solid rgba(245,158,11,.25);
      padding:12px 12px;
      border-radius:14px;
      font-size:13px;
      line-height:1.7;
    }

    label{font-size:12px;color:var(--muted);font-weight:650;}
    input[type="text"], textarea, select, input[type="date"]{
      background:#fff;
      color:var(--text);
      border:1px solid rgba(229,231,235,.95);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
    }
    textarea{
      width:100%;
      min-height:150px;
      resize:vertical;
      line-height:1.7;
    }
    select{min-width:260px}

    .poemCard{
      margin-top:10px;
      background: linear-gradient(180deg, rgba(17,24,39,.02), rgba(17,24,39,0));
      border:1px solid rgba(229,231,235,.95);
      border-radius: var(--radius-md);
      padding:12px;
    }
    .poemTitle{
      margin:0;
      font-size:22px;
      font-weight:900;
      letter-spacing:.3px;
      line-height:1.25;
      text-align:center; /* 标题居中 */
    }
    .poemMeta{
      margin-top:6px;
      color:var(--muted);
      font-size:12px;
      line-height:1.6;
    }
    .poemMetaBottom{
      margin-top:10px;
      text-align:center; /* 记录日期在底部并居中 */
    }
    .poemLines{
      margin-top:12px;
      padding:6px 4px 2px;
      text-align:center; /* 诗句整体居中 */
    }
    .poemLine{
      padding:6px 0;
      line-height:2.0;
      font-size:16px;
      letter-spacing:.2px;
      text-align:center; /* 每行诗句居中 */
    }
    .poemLine.highlight{
      color:var(--accent);
      font-weight:900;
      background:transparent;
    }
    .poemActions{
      margin-top:12px;
      display:flex;
      justify-content:flex-end; /* 按钮保持右下角 */
      gap:8px;
      flex-wrap:wrap;
    }

    details{
      border:1px solid rgba(229,231,235,.95);
      border-radius: var(--radius-md);
      background:#fff;
      box-shadow: var(--shadow-sm);
      overflow:hidden;
    }
    summary{
      cursor:pointer;
      padding:12px;
      list-style:none;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      background: rgba(17,24,39,.02);
    }
    summary::-webkit-details-marker{display:none}
    .groupBody{padding:0 12px 12px}
    .miniRow{
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
      padding:12px 0;
      border-top:1px solid rgba(229,231,235,.7);
    }
    .miniRow:first-child{border-top:none}
    .miniRow .left{min-width:260px}
    .miniRow .right{display:flex;gap:8px;flex-wrap:wrap}
    .kbd{
      border:1px solid rgba(229,231,235,.95);
      background:#fff;
      padding:2px 6px;
      border-radius:8px;
      font-size:12px;
      color:var(--muted)
    }

    .modalMask{
      position:fixed;
      inset:0;
      background:rgba(17,24,39,.50);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:20;
    }
    .modal{
      width:min(940px, 100%);
      background:#fff;
      border:1px solid rgba(229,231,235,.95);
      border-radius: 18px;
      padding:14px;
      box-shadow: 0 24px 70px rgba(17,24,39,.25);
    }
    .split{display:grid;grid-template-columns: 1fr 1fr;gap:12px;}
    @media (max-width: 980px){ .split{grid-template-columns:1fr;} }

    .linePicker{
      border:1px solid rgba(229,231,235,.95);
      border-radius: 14px;
      background:#fff;
      padding:10px;
      max-height:340px;
      overflow:auto;
    }
    .pickLine{
      padding:8px 10px;
      border-radius: 12px;
      cursor:pointer;
      border:1px solid transparent;
      line-height:1.6;
      display:flex;
      gap:10px;
    }
    .pickLine:hover{background:rgba(17,24,39,.03)}
    .pickLine.active{
      border-color: rgba(37,99,235,.35);
      color: var(--accent);
      font-weight: 900;
      background: rgba(37,99,235,.06);
    }

    .footNote{font-size:12px;color:var(--muted);line-height:1.7}
    .switch{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid rgba(229,231,235,.95);
      border-radius: 12px;
      background:#fff;
      color:var(--muted);
      font-size:13px;
      font-weight:650;
    }
    .switch input{transform:scale(1.12)}

    noscript{
      display:block;
      max-width:1120px;
      margin:18px auto;
      padding:12px 16px;
      border:1px solid rgba(239,68,68,.25);
      background: rgba(239,68,68,.08);
      border-radius:14px;
      color:#7f1d1d;
      font-size:13px;
      line-height:1.7;
    }
  </style>
</head>

<body>
  <noscript>检测到浏览器禁用了 JavaScript，因此页面无法渲染内容。请启用 JavaScript 后刷新。</noscript>

  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <h1>每日诗词记录</h1>
        <p class="sub">记录保存在本地浏览器；建议定期导出 JSON 备份。</p>
      </div>
      <div class="tabs">
        <div class="seg">
          <button class="tab active" id="tabToday">今日</button>
          <button class="tab" id="tabHistory">历史</button>
          <button class="tab" id="tabBackup">备份</button>
        </div>
        <button class="btn primary" id="btnAddTop">+ 记录诗词</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <div class="card" id="leftCard"></div>
      <div class="card" id="rightCard"></div>
    </div>
  </div>

  <div class="modalMask" id="modalMask" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="cardHead">
        <h2 id="modalTitle">记录诗词</h2>
        <div class="row">
          <button class="btn ghost small" id="btnCloseModal">关闭</button>
        </div>
      </div>
      <div class="hr"></div>

      <div class="split">
        <div class="col">
          <div class="row">
            <div style="flex:1">
              <label>日期（默认今天，可改）</label>
              <input type="date" id="fDate" />
            </div>
            <div style="flex:1">
              <label>题目（必填，用于全库查重）</label>
              <input type="text" id="fTitle" placeholder="如：静夜思" />
            </div>
          </div>

          <div class="row">
            <div style="flex:1">
              <label>作者（可选）</label>
              <input type="text" id="fAuthor" placeholder="如：李白" />
            </div>
            <div style="flex:1">
              <label>朝代（可选）</label>
              <input type="text" id="fDynasty" placeholder="如：唐" />
            </div>
          </div>

          <div class="row" style="justify-content:space-between">
            <div class="switch">
              <input type="checkbox" id="fSetAsMain" />
              <label for="fSetAsMain" style="margin:0;cursor:pointer">设为当日主诗</label>
            </div>
            <div class="meta">主诗可指向历史记录（不必是当天新记录）。</div>
          </div>

          <div>
            <label>诗词正文（整首，建议每行一句；粘贴即可）</label>
            <textarea id="fPoem" placeholder="床前明月光&#10;疑是地上霜&#10;举头望明月&#10;低头思故乡"></textarea>
            <div class="footNote">会自动去掉空行。重点句仅“彩色 + 加粗”，不加底色。</div>
          </div>

          <div>
            <label>备注（可选）</label>
            <input type="text" id="fNote" placeholder="如：今天卡在第二句 / 想重点复习第三句" />
          </div>

          <div class="row" style="justify-content:flex-end">
            <button class="btn danger small" id="btnDeleteInModal" style="display:none">删除</button>
            <button class="btn primary" id="btnSave">保存</button>
          </div>
        </div>

        <div>
          <div class="row" style="justify-content:space-between">
            <div class="pill">选择重点句（可多选）</div>
            <div class="meta">已选 <span id="selCount">0</span> 行（至少 1 行）</div>
          </div>
          <div class="linePicker" id="linePicker">
            <div class="meta">先在左侧输入正文，这里会出现逐行预览。</div>
          </div>
          <div class="row" style="justify-content:flex-end;margin-top:10px">
            <button class="btn small ghost" id="btnClearSel">清空选择</button>
            <button class="btn small ghost" id="btnSelectAll">全选</button>
          </div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="footNote">
        说明：只记录诗词（整首 + 若干重点句）。全库按“题目”去重；若重复可选择编辑旧记录或直接设为当日主诗。
      </div>
    </div>
  </div>

<script>
(function(){
  // --------- 兜底：任何错误直接显示在页面，不让“空白” ---------
  function escapeHtml(s){
    return String(s)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }
  function showFatal(err){
    var msg = (err && err.stack) ? err.stack : String(err);
    document.body.innerHTML =
      '<div style="max-width:900px;margin:40px auto;padding:16px;font-family:system-ui,-apple-system,Segoe UI,PingFang SC,Microsoft YaHei,Arial;">' +
      '<h2 style="margin:0 0 12px 0;">页面脚本出错（已停止渲染）</h2>' +
      '<div style="color:#6b7280;line-height:1.6;margin-bottom:12px;">' +
      '请把下面错误信息截图发我，我能立刻定位原因（常见是浏览器兼容或复制不完整）。' +
      '</div>' +
      '<pre style="white-space:pre-wrap;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;line-height:1.5;">' +
      escapeHtml(msg) +
      '</pre>' +
      '</div>';
  }
  if (window.addEventListener){
    window.addEventListener('error', function(e){
      try{ showFatal(e.error || e.message || e); }catch(_){}
    });
  }

  // --------- 工具函数（ES5 兼容） ---------
  function nowTs(){ return new Date().getTime(); }
  function pad2(n){ return (n<10 ? "0" : "") + n; }
  function dateKey(d){
    d = d || new Date();
    return d.getFullYear() + "-" + pad2(d.getMonth()+1) + "-" + pad2(d.getDate());
  }
  function yesterdayKey(){
    var d = new Date();
    d.setDate(d.getDate() - 1);
    return dateKey(d);
  }
  function isArray(x){ return Object.prototype.toString.call(x) === "[object Array]"; }
  function ensurePlainObject(x){
    return (x && typeof x === "object" && !isArray(x)) ? x : {};
  }
  function safeLines(lines){
    if(!isArray(lines)) return [];
    var out = [];
    for(var i=0;i<lines.length;i++){
      var s = String(lines[i] || "").replace(/^\s+|\s+$/g,"");
      if(s) out.push(s);
    }
    return out;
  }
  function normTitle(t){
    return String(t || "").replace(/^\s+|\s+$/g,"").replace(/\s+/g," ");
  }
  function uuid(){
    try{
      if(window.crypto && crypto.randomUUID) return crypto.randomUUID();
    }catch(_){}
    return "id_" + Math.random().toString(16).slice(2) + "_" + nowTs();
  }

  // --------- 存储 ---------
  var LS_KEY = "poem_journal_v2";

  function saveDB(db){
    try{ localStorage.setItem(LS_KEY, JSON.stringify(db)); }catch(e){}
  }

  function migrateDB(db){
    db = db || {};
    db.version = db.version || 3;
    db.records = isArray(db.records) ? db.records : [];
    db.ui = ensurePlainObject(db.ui);

    db.ui.activeTab = db.ui.activeTab || "today";
    db.ui.selectedDate = db.ui.selectedDate || yesterdayKey();
    db.ui.selectedRecordByDate = ensurePlainObject(db.ui.selectedRecordByDate);
    db.ui.mainByDate = ensurePlainObject(db.ui.mainByDate);
    db.ui.historyQuery = (db.ui.historyQuery != null) ? String(db.ui.historyQuery) : "";
    db.ui.reviewRandomId = db.ui.reviewRandomId || null;

    for(var i=0;i<db.records.length;i++){
      var r = db.records[i];
      if(!r.id) r.id = uuid();
      r.createdDate = r.createdDate || dateKey();
      r.createdAt = r.createdAt || nowTs();
      r.updatedAt = r.updatedAt || r.createdAt;

      r.poemLines = safeLines(r.poemLines || []);
      if(r.poemLines.length === 0) r.poemLines = [""];

      // 兼容老字段 highlightIndex -> highlightIndices
      if(!isArray(r.highlightIndices)){
        if(typeof r.highlightIndex === "number") r.highlightIndices = [r.highlightIndex];
        else r.highlightIndices = [0];
      }

      // 修正索引范围并去重
      var maxIdx = Math.max(0, r.poemLines.length - 1);
      var seen = {};
      var fixed = [];
      for(var j=0;j<r.highlightIndices.length;j++){
        var idx = parseInt(r.highlightIndices[j],10);
        if(isNaN(idx)) continue;
        if(idx<0) idx=0;
        if(idx>maxIdx) idx=maxIdx;
        if(!seen[idx]){
          seen[idx]=true;
          fixed.push(idx);
        }
      }
      fixed.sort(function(a,b){return a-b;});
      if(fixed.length === 0) fixed = [0];
      r.highlightIndices = fixed;

      if(typeof r.lastReviewedAt === "undefined") r.lastReviewedAt = null;
      if(typeof r.reviewCount === "undefined") r.reviewCount = 0;
      if(typeof r.nextDueAt === "undefined") r.nextDueAt = null;
    }
    saveDB(db);
    return db;
  }

  function loadDB(){
    try{
      var raw = localStorage.getItem(LS_KEY);
      if(raw){
        var db = JSON.parse(raw);
        return migrateDB(db);
      }
    }catch(e){}
    // 兼容 v1
    try{
      var raw1 = localStorage.getItem("poem_journal_v1");
      if(raw1){
        var old = JSON.parse(raw1);
        if(old && isArray(old.records)){
          var db2 = { version:3, records: old.records, ui: old.ui || {} };
          return migrateDB(db2);
        }
      }
    }catch(e){}
    return migrateDB({ version:3, records:[], ui:{} });
  }

  var db = loadDB();

  // --------- 复习逻辑 ---------
  var REVIEW_INTERVAL_DAYS = [1,3,7,14,30,60,120];

  function nextDueFrom(count, fromTs){
    var idx = count-1;
    if(idx<0) idx=0;
    if(idx>REVIEW_INTERVAL_DAYS.length-1) idx=REVIEW_INTERVAL_DAYS.length-1;
    return fromTs + REVIEW_INTERVAL_DAYS[idx]*24*60*60*1000;
  }

  function isDue(rec, now){
    now = now || nowTs();
    if(rec.nextDueAt != null) return now >= rec.nextDueAt;
    if(!rec.lastReviewedAt) return true;
    if(!rec.reviewCount || rec.reviewCount<=0) return now >= (rec.lastReviewedAt + 24*60*60*1000);
    return now >= nextDueFrom(rec.reviewCount, rec.lastReviewedAt);
  }

  function markKnow(recId){
    var rec = findRecord(recId);
    if(!rec) return;
    var t = nowTs();
    rec.reviewCount = (rec.reviewCount || 0) + 1;
    rec.lastReviewedAt = t;
    rec.nextDueAt = nextDueFrom(rec.reviewCount, t);
    rec.updatedAt = t;
    saveDB(db);
    render();
  }
  function markAgain(recId){
    var rec = findRecord(recId);
    if(!rec) return;
    var t = nowTs();
    rec.lastReviewedAt = t;
    rec.nextDueAt = t + 24*60*60*1000;
    rec.updatedAt = t;
    saveDB(db);
    render();
  }

  // --------- 查找/辅助 ---------
  function findRecord(id){
    for(var i=0;i<db.records.length;i++){
      if(db.records[i].id === id) return db.records[i];
    }
    return null;
  }

  function recTitle(rec){
    var t = rec.title ? String(rec.title).replace(/^\s+|\s+$/g,"") : "";
    var a = rec.author ? String(rec.author).replace(/^\s+|\s+$/g,"") : "";
    var d = rec.dynasty ? String(rec.dynasty).replace(/^\s+|\s+$/g,"") : "";
    var left = t ? "《" + t + "》" : "（未命名）";
    var right = [];
    if(d) right.push(d);
    if(a) right.push(a);
    return right.length ? (left + " · " + right.join("·")) : left;
  }

  function daysAgo(ts){
    if(!ts) return "未复习过";
    var now = new Date();
    var d = new Date(ts);
    var n0 = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
    var d0 = new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime();
    var diff = Math.round((n0 - d0) / (24*60*60*1000));
    if(diff <= 0) return "今天";
    if(diff === 1) return "1 天前";
    return diff + " 天前";
  }

  function getRecordsByDate(d){
    var out = [];
    for(var i=0;i<db.records.length;i++){
      if(db.records[i].createdDate === d) out.push(db.records[i]);
    }
    out.sort(function(a,b){ return (b.createdAt||0) - (a.createdAt||0); });
    return out;
  }

  function setMainForDate(d, recId){
    db.ui.mainByDate = ensurePlainObject(db.ui.mainByDate);
    db.ui.mainByDate[d] = recId;
    saveDB(db);
  }

  function getMainRecordForDate(d){
    var recs = getRecordsByDate(d);

    db.ui.mainByDate = ensurePlainObject(db.ui.mainByDate);
    db.ui.selectedRecordByDate = ensurePlainObject(db.ui.selectedRecordByDate);

    var mainId = db.ui.mainByDate[d] || null;
    var main = mainId ? findRecord(mainId) : null;

    var selectedId = db.ui.selectedRecordByDate[d] || null;
    var selected = selectedId ? findRecord(selectedId) : null;

    var active = selected || main || (recs.length ? recs[0] : null);

    // options：main + 当天记录去重
    var options = [];
    var seen = {};
    if(main){ options.push(main); seen[main.id]=true; }
    for(var i=0;i<recs.length;i++){
      if(!seen[recs[i].id]){
        options.push(recs[i]);
        seen[recs[i].id]=true;
      }
    }
    return { recs:recs, main:main, active:active, options:options };
  }

  function chooseRandom(arr, excludeId){
    if(!arr || !arr.length) return null;
    if(arr.length === 1) return arr[0];
    var pool = [];
    for(var i=0;i<arr.length;i++){
      if(arr[i].id !== excludeId) pool.push(arr[i]);
    }
    if(!pool.length) pool = arr.slice(0);
    var idx = Math.floor(Math.random() * pool.length);
    return pool[idx];
  }

  function groupByDate(records){
    var groups = {}; // date -> array
    for(var i=0;i<records.length;i++){
      var r = records[i];
      var k = r.createdDate || "未知日期";
      if(!groups[k]) groups[k] = [];
      groups[k].push(r);
    }
    var keys = [];
    for(var key in groups){
      if(groups.hasOwnProperty(key)){
        groups[key].sort(function(a,b){ return (b.createdAt||0) - (a.createdAt||0); });
        keys.push(key);
      }
    }
    keys.sort(function(a,b){ return a<b ? 1 : -1; }); // desc
    return { keys:keys, groups:groups };
  }

  // --------- DOM 引用 ---------
  var left = document.getElementById("leftCard");
  var right = document.getElementById("rightCard");

  var tabToday = document.getElementById("tabToday");
  var tabHistory = document.getElementById("tabHistory");
  var tabBackup = document.getElementById("tabBackup");

  var btnAddTop = document.getElementById("btnAddTop");

  var modalMask = document.getElementById("modalMask");
  var btnCloseModal = document.getElementById("btnCloseModal");
  var modalTitle = document.getElementById("modalTitle");

  var btnSave = document.getElementById("btnSave");
  var btnDeleteInModal = document.getElementById("btnDeleteInModal");

  var fDate = document.getElementById("fDate");
  var fTitle = document.getElementById("fTitle");
  var fAuthor = document.getElementById("fAuthor");
  var fDynasty = document.getElementById("fDynasty");
  var fPoem = document.getElementById("fPoem");
  var fNote = document.getElementById("fNote");
  var fSetAsMain = document.getElementById("fSetAsMain");

  var linePicker = document.getElementById("linePicker");
  var selCount = document.getElementById("selCount");
  var btnClearSel = document.getElementById("btnClearSel");
  var btnSelectAll = document.getElementById("btnSelectAll");

  // --------- Tab ---------
  var activeTab = db.ui.activeTab || "today";
  function persistUI(){
    db.ui.activeTab = activeTab;
    saveDB(db);
  }
  function setActiveTab(){
    tabToday.className = tabToday.className.replace(/\bactive\b/g,"").replace(/\s+/g," ").replace(/^\s+|\s+$/g,"");
    tabHistory.className = tabHistory.className.replace(/\bactive\b/g,"").replace(/\s+/g," ").replace(/^\s+|\s+$/g,"");
    tabBackup.className = tabBackup.className.replace(/\bactive\b/g,"").replace(/\s+/g," ").replace(/^\s+|\s+$/g,"");
    if(activeTab==="today") tabToday.className += " active";
    if(activeTab==="history") tabHistory.className += " active";
    if(activeTab==="backup") tabBackup.className += " active";
  }
  tabToday.onclick = function(){ activeTab="today"; persistUI(); render(); };
  tabHistory.onclick = function(){ activeTab="history"; persistUI(); render(); };
  tabBackup.onclick = function(){ activeTab="backup"; persistUI(); render(); };

  // --------- Modal 状态（不用 Set，兼容） ---------
  var modalMode = "add";
  var editingId = null;
  var editingOriginalDate = null;

  // 选择重点句：用对象当集合
  var selectedMap = {}; // idx -> true

  function selectedSize(){
    var c=0; for(var k in selectedMap){ if(selectedMap.hasOwnProperty(k)) c++; }
    return c;
  }
  function clearSelected(){ selectedMap = {}; }
  function addSelected(idx){ selectedMap[String(idx)] = true; }
  function hasSelected(idx){ return !!selectedMap[String(idx)]; }
  function toggleSelected(idx){
    var k = String(idx);
    if(selectedMap[k]) delete selectedMap[k];
    else selectedMap[k]=true;
  }
  function ensureAtLeastOne(){
    if(selectedSize()===0) addSelected(0);
  }
  function selectedToArray(){
    var arr = [];
    for(var k in selectedMap){
      if(selectedMap.hasOwnProperty(k)) arr.push(parseInt(k,10));
    }
    arr.sort(function(a,b){return a-b;});
    return arr;
  }
  function arrayToSelected(arr){
    selectedMap = {};
    if(!arr || !arr.length){
      addSelected(0);
      return;
    }
    for(var i=0;i<arr.length;i++){
      addSelected(arr[i]);
    }
    ensureAtLeastOne();
  }

  btnAddTop.onclick = function(){ openAddModal(); };
  btnCloseModal.onclick = function(){ closeModal(); };
  modalMask.onclick = function(e){ if(e && e.target === modalMask) closeModal(); };

  fPoem.oninput = function(){ renderLinePicker(); };
  btnClearSel.onclick = function(){ clearSelected(); ensureAtLeastOne(); renderLinePicker(); };
  btnSelectAll.onclick = function(){
    var lines = safeLines(String(fPoem.value || "").split("\n"));
    clearSelected();
    for(var i=0;i<lines.length;i++) addSelected(i);
    ensureAtLeastOne();
    renderLinePicker();
  };

  function openAddModal(){
    modalMode = "add";
    editingId = null;
    editingOriginalDate = null;

    modalTitle.innerHTML = "记录诗词";
    btnDeleteInModal.style.display = "none";

    fDate.value = dateKey();
    fTitle.value = "";
    fAuthor.value = "";
    fDynasty.value = "";
    fPoem.value = "";
    fNote.value = "";
    fSetAsMain.checked = true;

    clearSelected();
    addSelected(0);
    renderLinePicker();
    modalMask.style.display = "flex";
  }

  function openEditModal(recId){
    var rec = findRecord(recId);
    if(!rec) return;

    modalMode = "edit";
    editingId = recId;
    editingOriginalDate = rec.createdDate || null;

    modalTitle.innerHTML = "编辑记录";
    btnDeleteInModal.style.display = "inline-block";

    fDate.value = rec.createdDate || dateKey();
    fTitle.value = rec.title || "";
    fAuthor.value = rec.author || "";
    fDynasty.value = rec.dynasty || "";
    fPoem.value = safeLines(rec.poemLines).join("\n");
    fNote.value = rec.note || "";

    arrayToSelected(rec.highlightIndices || [0]);

    var d = rec.createdDate || dateKey();
    db.ui.mainByDate = ensurePlainObject(db.ui.mainByDate);
    fSetAsMain.checked = (db.ui.mainByDate[d] === rec.id);

    renderLinePicker();
    modalMask.style.display = "flex";
  }

  function closeModal(){ modalMask.style.display = "none"; }

  function renderLinePicker(){
    var lines = safeLines(String(fPoem.value || "").split("\n"));
    if(!lines.length){
      linePicker.innerHTML = '<div class="meta">先在左侧输入正文，这里会出现逐行预览。</div>';
      selCount.innerHTML = "0";
      return;
    }
    // 纠正选择范围
    var maxIdx = lines.length - 1;
    var newMap = {};
    for(var k in selectedMap){
      if(selectedMap.hasOwnProperty(k)){
        var idx = parseInt(k,10);
        if(isNaN(idx)) continue;
        if(idx<0) idx=0;
        if(idx>maxIdx) idx=maxIdx;
        newMap[String(idx)] = true;
      }
    }
    selectedMap = newMap;
    ensureAtLeastOne();

    selCount.innerHTML = String(selectedSize());

    var html = "";
    for(var i=0;i<lines.length;i++){
      var active = hasSelected(i) ? "active" : "";
      html += ''
        + '<div class="pickLine ' + active + '" data-idx="' + i + '">'
        + '<div style="width:28px;color:#9ca3af;font-size:12px;font-weight:650">' + (i+1) + '</div>'
        + '<div style="flex:1">' + escapeHtml(lines[i]) + '</div>'
        + '</div>';
    }
    linePicker.innerHTML = html;

    varels = linePicker.querySelectorAll(".pickLine");
    for(var j=0;j<els.length;j++){
      els[j].onclick = function(){
        var idx2 = parseInt(this.getAttribute("data-idx"),10);
        toggleSelected(idx2);
        ensureAtLeastOne();
        renderLinePicker();
      };
    }
  }

  btnSave.onclick = function(){
    var d = fDate.value || dateKey();

    var titleNow = normTitle(fTitle.value);
    if(!titleNow){ alert("请填写题目（用于全库查重）。"); return; }

    var poemLines = safeLines(String(fPoem.value || "").split("\n"));
    if(!poemLines.length){ alert("请先输入诗词正文（至少一行）。"); return; }

    // 生成 highlightIndices
    var maxIdx = Math.max(0, poemLines.length - 1);
    var arr = selectedToArray();
    var fixed = [];
    var seen = {};
    for(var i=0;i<arr.length;i++){
      var idx = parseInt(arr[i],10);
      if(isNaN(idx)) continue;
      if(idx<0) idx=0;
      if(idx>maxIdx) idx=maxIdx;
      if(!seen[idx]){ seen[idx]=true; fixed.push(idx); }
    }
    fixed.sort(function(a,b){return a-b;});
    if(!fixed.length) fixed = [0];

    var payload = {
      createdDate: d,
      title: titleNow,
      author: String(fAuthor.value || "").replace(/^\s+|\s+$/g,"") || null,
      dynasty: String(fDynasty.value || "").replace(/^\s+|\s+$/g,"") || null,
      poemLines: poemLines,
      highlightIndices: fixed,
      note: String(fNote.value || "").replace(/^\s+|\s+$/g,"") || null
    };

    if(modalMode === "add"){
      // 全库按题目去重
      var dup = null;
      for(var k=0;k<db.records.length;k++){
        if(normTitle(db.records[k].title) === titleNow){ dup = db.records[k]; break; }
      }
      if(dup){
        var goEdit = confirm(
          "检测到已存在同题目记录：《" + titleNow + "》\n" +
          "原记录日期：" + (dup.createdDate || "未知") + "\n\n" +
          "点“确定”去编辑旧记录；点“取消”继续下一步。"
        );
        if(goEdit){ closeModal(); openEditModal(dup.id); return; }

        var setMain = confirm(
          "是否将“已有的《" + titleNow + "》”设为 " + d + " 的主诗？\n（不新增记录，只设置主诗指向）"
        );
        if(setMain){
          setMainForDate(d, dup.id);
          db.ui.selectedDate = d;
          db.ui.selectedRecordByDate = ensurePlainObject(db.ui.selectedRecordByDate);
          db.ui.selectedRecordByDate[d] = dup.id;
          saveDB(db);
          closeModal();
          render();
        }
        return;
      }

      var rec = {
        id: uuid(),
        createdDate: payload.createdDate,
        title: payload.title,
        author: payload.author,
        dynasty: payload.dynasty,
        poemLines: payload.poemLines,
        highlightIndices: payload.highlightIndices,
        note: payload.note,
        createdAt: nowTs(),
        updatedAt: nowTs(),
        lastReviewedAt: null,
        reviewCount: 0,
        nextDueAt: null
      };
      db.records.unshift(rec);

      if(fSetAsMain.checked) setMainForDate(d, rec.id);

      db.ui.selectedDate = d;
      db.ui.selectedRecordByDate = ensurePlainObject(db.ui.selectedRecordByDate);
      db.ui.selectedRecordByDate[d] = rec.id;

      saveDB(db);
      closeModal();
      render();
      return;
    }

    if(modalMode === "edit" && editingId){
      var rec2 = findRecord(editingId);
      if(!rec2) return;

      // 题目冲突检查
      for(var x=0;x<db.records.length;x++){
        var rr = db.records[x];
        if(rr.id !== rec2.id && normTitle(rr.title) === titleNow){
          var goEdit2 = confirm(
            "题目《" + titleNow + "》已存在另一条记录（日期：" + (rr.createdDate || "未知") + "）。\n\n" +
            "点“确定”去编辑那条已有记录；点“取消”返回修改。"
          );
          if(goEdit2){ closeModal(); openEditModal(rr.id); }
          return;
        }
      }

      var oldDate = editingOriginalDate || rec2.createdDate;

      rec2.createdDate = payload.createdDate;
      rec2.title = payload.title;
      rec2.author = payload.author;
      rec2.dynasty = payload.dynasty;
      rec2.poemLines = payload.poemLines;
      rec2.highlightIndices = payload.highlightIndices;
      rec2.note = payload.note;
      rec2.updatedAt = nowTs();

      db.ui.mainByDate = ensurePlainObject(db.ui.mainByDate);

      if(oldDate && oldDate !== d && db.ui.mainByDate[oldDate] === rec2.id){
        delete db.ui.mainByDate[oldDate];
      }
      if(fSetAsMain.checked){
        setMainForDate(d, rec2.id);
      }else{
        if(db.ui.mainByDate[d] === rec2.id){
          delete db.ui.mainByDate[d];
          saveDB(db);
        }
      }

      db.ui.selectedDate = d;
      db.ui.selectedRecordByDate = ensurePlainObject(db.ui.selectedRecordByDate);
      db.ui.selectedRecordByDate[d] = rec2.id;

      saveDB(db);
      closeModal();
      render();
    }
  };

  btnDeleteInModal.onclick = function(){
    if(!editingId) return;
    var ok = confirm("确定删除这条记录？删除后无法恢复（除非你有备份）。");
    if(!ok) return;

    var rec = findRecord(editingId);

    db.ui.mainByDate = ensurePlainObject(db.ui.mainByDate);
    if(rec && db.ui.mainByDate[rec.createdDate] === rec.id){
      delete db.ui.mainByDate[rec.createdDate];
    }
    if(db.ui.reviewRandomId === editingId) db.ui.reviewRandomId = null;

    for(var k in db.ui.mainByDate){
      if(db.ui.mainByDate.hasOwnProperty(k) && db.ui.mainByDate[k] === editingId){
        delete db.ui.mainByDate[k];
      }
    }

    var newArr = [];
    for(var i=0;i<db.records.length;i++){
      if(db.records[i].id !== editingId) newArr.push(db.records[i]);
    }
    db.records = newArr;

    saveDB(db);
    closeModal();
    render();
  };

  // --------- 渲染 ---------
  function buildHighlightMap(indices){
    var m = {};
    if(indices && indices.length){
      for(var i=0;i<indices.length;i++){
        m[String(indices[i])] = true;
      }
    }
    return m;
  }

  // ✅ 这里已改：记录日期移到底部
  function renderPoemCard(rec, actionsHtml){
    var lines = safeLines(rec.poemLines);
    var hi = buildHighlightMap(rec.highlightIndices || []);
    var title = recTitle(rec);

    // 顶部 meta：不放记录日期
    var metaTop = [];
    metaTop.push("上次复习：" + (rec.lastReviewedAt ? daysAgo(rec.lastReviewedAt) : "未复习过"));
    metaTop.push("复习次数：" + (rec.reviewCount || 0));

    // 底部日期
    var dateLine = rec.createdDate ? ("记录日期：" + rec.createdDate) : "";

    var html = '';
    html += '<div class="poemCard">';
    html +=   '<div class="poemTitle">' + escapeHtml(title) + '</div>';
    html +=   '<div class="poemMeta">' + escapeHtml(metaTop.join(" · ")) + '</div>';

    html +=   '<div class="poemLines">';
    for(var i=0;i<lines.length;i++){
      var cls = hi[String(i)] ? "poemLine highlight" : "poemLine";
      html += '<div class="' + cls + '">' + escapeHtml(lines[i]) + '</div>';
    }
    html +=   '</div>';

    if(rec.note){
      html += '<div class="poemMeta" style="margin-top:8px">备注：' + escapeHtml(rec.note) + '</div>';
    }

    html +=   '<div class="poemActions">' + (actionsHtml || "") + '</div>';

    if(dateLine){
      html += '<div class="poemMeta poemMetaBottom">' + escapeHtml(dateLine) + '</div>';
    }

    html += '</div>';
    return html;
  }

  function renderToday(){
    db.ui.selectedDate = db.ui.selectedDate || yesterdayKey();
    var selectedDate = db.ui.selectedDate;

    var pack = getMainRecordForDate(selectedDate);
    var recs = pack.recs;
    var active = pack.active;
    var options = pack.options;

    var now = nowTs();
    var duePool = [];
    for(var i=0;i<db.records.length;i++){
      if(isDue(db.records[i], now)) duePool.push(db.records[i]);
    }
    var pool = duePool.length ? duePool : db.records.slice(0);

    var reviewRec = null;
    if(pool.length){
      var currentId = db.ui.reviewRandomId;
      reviewRec = currentId ? findRecord(currentId) : null;
      if(!reviewRec){
        reviewRec = chooseRandom(pool, null);
        db.ui.reviewRandomId = reviewRec ? reviewRec.id : null;
        saveDB(db);
      }
    }else{
      db.ui.reviewRandomId = null;
      saveDB(db);
    }

    var leftHtml = '';
    leftHtml += '<div class="cardHead"><h2>当日主诗</h2><div class="sub2">选日期查看；主诗可指向历史记录</div></div>';
    leftHtml += '<div class="hr"></div>';
    leftHtml += '<div class="row" style="justify-content:space-between">';
    leftHtml +=   '<div class="row"><label>日期</label><input type="date" id="mainDate" value="' + escapeHtml(selectedDate) + '"/></div>';
    leftHtml +=   '<div class="pill">该日新记录：' + recs.length + ' 条</div>';
    leftHtml += '</div>';

    if(!active){
      leftHtml += '<div class="notice" style="margin-top:12px">该日期没有可显示的诗（既没有新记录，也未设置主诗）。你可以新增一条，或把历史诗设为该日主诗。</div>';
    }else{
      if(options.length > 1){
        leftHtml += '<div class="row" style="justify-content:flex-end;margin-top:12px">';
        leftHtml += '<label>查看</label><select id="selRecord"></select>';
        leftHtml += '</div>';
      }
      leftHtml += renderPoemCard(active,
        '<button class="btn small good" id="btnMainKnow">已会</button>' +
        '<button class="btn small warn" id="btnMainAgain">再来</button>' +
        '<button class="btn small ghost" id="btnMainEdit">编辑</button>'
      );
    }
    left.innerHTML = leftHtml;

    var rightHtml = '';
    rightHtml += '<div class="cardHead"><h2>随机复习</h2><div class="sub2">每次只显示 1 首</div></div>';
    rightHtml += '<div class="hr"></div>';
    rightHtml += '<div class="row" style="justify-content:flex-end"><button class="btn small primary" id="btnReroll">随机换一首</button></div>';
    if(!reviewRec){
      rightHtml += '<div class="meta" style="margin-top:12px">还没有可复习的诗。先新增几条记录。</div>';
    }else{
      rightHtml += renderPoemCard(reviewRec,
        '<button class="btn small good" data-ract="know" data-id="' + reviewRec.id + '">已会</button>' +
        '<button class="btn small warn" data-ract="again" data-id="' + reviewRec.id + '">再来</button>' +
        '<button class="btn small ghost" data-ract="edit" data-id="' + reviewRec.id + '">编辑</button>'
      );
    }
    rightHtml += '<div class="hr"></div><div class="pill">提示</div><div class="meta">数据保存在本地浏览器。建议定期去“备份”导出 JSON。</div>';
    right.innerHTML = rightHtml;

    // 绑定事件
    var mainDateEl = document.getElementById("mainDate");
    if(mainDateEl){
      mainDateEl.onchange = function(e){
        db.ui.selectedDate = e.target.value || db.ui.selectedDate;
        saveDB(db);
        render();
      };
    }

    if(active && options.length > 1){
      var sel = document.getElementById("selRecord");
      db.ui.mainByDate = ensurePlainObject(db.ui.mainByDate);
      var mainId = db.ui.mainByDate[selectedDate] || null;

      var optHtml = "";
      for(var ii=0;ii<options.length;ii++){
        var r = options[ii];
        var tag = (mainId && r.id === mainId) ? "（主诗）" : (r.createdDate === selectedDate ? "（当天）" : "（历史）");
        var selected = (r.id === active.id) ? ' selected="selected"' : "";
        optHtml += '<option value="' + r.id + '"' + selected + '>' + (ii+1) + ". " + escapeHtml(recTitle(r)) + " " + tag + '</option>';
      }
      sel.innerHTML = optHtml;

      sel.onchange = function(){
        db.ui.selectedRecordByDate = ensurePlainObject(db.ui.selectedRecordByDate);
        db.ui.selectedRecordByDate[selectedDate] = sel.value;
        saveDB(db);
        render();
      };
    }

    if(active){
      var k1 = document.getElementById("btnMainKnow");
      var k2 = document.getElementById("btnMainAgain");
      var k3 = document.getElementById("btnMainEdit");
      if(k1) k1.onclick = function(){ markKnow(active.id); };
      if(k2) k2.onclick = function(){ markAgain(active.id); };
      if(k3) k3.onclick = function(){ openEditModal(active.id); };
    }

    var reroll = document.getElementById("btnReroll");
    if(reroll){
      reroll.onclick = function(){
        var now2 = nowTs();
        var due2 = [];
        for(var i2=0;i2<db.records.length;i2++){
          if(isDue(db.records[i2], now2)) due2.push(db.records[i2]);
        }
        var pool2 = due2.length ? due2 : db.records.slice(0);
        var next = chooseRandom(pool2, db.ui.reviewRandomId);
        db.ui.reviewRandomId = next ? next.id : null;
        saveDB(db);
        render();
      };
    }

    var rBtns = right.querySelectorAll("button[data-ract]");
    for(var b=0;b<rBtns.length;b++){
      rBtns[b].onclick = function(){
        var act = this.getAttribute("data-ract");
        var id = this.getAttribute("data-id");
        if(act==="know") return markKnow(id);
        if(act==="again") return markAgain(id);
        if(act==="edit") return openEditModal(id);
      };
    }
  }

  var historyQuery = db.ui.historyQuery || "";

  function renderMiniRow(rec){
    var reviewed = rec.lastReviewedAt ? daysAgo(rec.lastReviewedAt) : "未复习过";
    var html = '';
    html += '<div class="miniRow">';
    html +=   '<div class="left">';
    html +=     '<div style="font-weight:850;font-size:14px">' + escapeHtml(recTitle(rec)) + '</div>';
    html +=     '<div class="meta">记录日期：' + escapeHtml(rec.createdDate || "") + '</div>';
    html +=     '<div class="meta">上次复习：' + escapeHtml(reviewed) + ' · 复习次数：' + (rec.reviewCount||0) + '</div>';
    html +=     '<div id="full_' + rec.id + '" style="display:none;margin-top:10px">';
    html +=       renderPoemCard(rec,
                  '<button class="btn small good" data-hact="know" data-id="' + rec.id + '">已会</button>' +
                  '<button class="btn small warn" data-hact="again" data-id="' + rec.id + '">再来</button>' +
                  '<button class="btn small ghost" data-hact="edit" data-id="' + rec.id + '">编辑</button>' +
                  '<button class="btn small danger" data-hact="del" data-id="' + rec.id + '">删除</button>'
                );
    html +=     '</div>';
    html +=   '</div>';
    html +=   '<div class="right"><button class="btn small ghost" data-hact="toggle" data-id="' + rec.id + '">展开/收起</button></div>';
    html += '</div>';
    return html;
  }

  function renderDateGroup(dateStr, recs){
    var html = '';
    html += '<details open>';
    html +=   '<summary><div class="row"><div class="pill">' + escapeHtml(dateStr) + '</div><div class="meta">共 ' + recs.length + ' 条</div></div><div class="meta">点击展开/折叠</div></summary>';
    html +=   '<div class="groupBody">';
    for(var i=0;i<recs.length;i++) html += renderMiniRow(recs[i]);
    html +=   '</div>';
    html += '</details>';
    return html;
  }

  function renderHistory(){
    var total = db.records.length;
    var q = String(historyQuery || "").replace(/^\s+|\s+$/g,"");

    var filtered = [];
    if(q){
      var ql = q.toLowerCase();
      for(var i=0;i<db.records.length;i++){
        var r = db.records[i];
        var hay = [];
        if(r.createdDate) hay.push(r.createdDate);
        if(r.title) hay.push(r.title);
        if(r.author) hay.push(r.author);
        if(r.dynasty) hay.push(r.dynasty);
        var pl = safeLines(r.poemLines || []);
        for(var j=0;j<pl.length;j++) hay.push(pl[j]);
        if(r.note) hay.push(r.note);

        if(hay.join("\n").toLowerCase().indexOf(ql) >= 0) filtered.push(r);
      }
    }else{
      filtered = db.records.slice(0);
    }

    var grouped = groupByDate(filtered);

    var leftHtml = '';
    leftHtml += '<div class="cardHead"><h2>历史记录</h2><div class="sub2">共 ' + total + ' 条' + (q ? (' · 匹配 ' + filtered.length + ' 条') : '') + '</div></div>';
    leftHtml += '<div class="hr"></div>';
    leftHtml += '<div class="row"><input type="text" id="historySearch" placeholder="搜索：题目 / 作者 / 正文关键词 / 备注" value="' + escapeHtml(q) + '" style="flex:1;min-width:260px" /><button class="btn ghost" id="btnClearSearch">清空</button></div>';
    leftHtml += '<div class="hr"></div>';

    if(!grouped.keys.length){
      leftHtml += '<div class="meta">没有记录。点击右上角 <span class="kbd">+ 记录诗词</span> 添加第一条。</div>';
    }else{
      leftHtml += '<div class="col" style="gap:10px">';
      for(var k=0;k<grouped.keys.length;k++){
        var key = grouped.keys[k];
        leftHtml += renderDateGroup(key, grouped.groups[key]);
      }
      leftHtml += '</div>';
    }
    left.innerHTML = leftHtml;

    right.innerHTML =
      '<div class="cardHead"><h2>说明</h2><div class="sub2">全库去重与主诗</div></div>' +
      '<div class="hr"></div>' +
      '<div class="meta">' +
      '新增时按“题目”全库去重：历史里已有同题目就不再新增。<br/>' +
      '遇到重复可选择：编辑旧记录，或把旧记录设为选定日期主诗。<br/>' +
      '主诗可指向历史记录（不必是当天新增）。' +
      '</div>';

    var hs = document.getElementById("historySearch");
    if(hs){
      hs.oninput = function(e){
        historyQuery = e.target.value;
        db.ui.historyQuery = historyQuery;
        saveDB(db);
        renderHistory();
      };
    }
    var clr = document.getElementById("btnClearSearch");
    if(clr){
      clr.onclick = function(){
        historyQuery = "";
        db.ui.historyQuery = "";
        saveDB(db);
        render();
      };
    }

    var btns = left.querySelectorAll("button[data-hact]");
    for(var i2=0;i2<btns.length;i2++){
      btns[i2].onclick = function(){
        var act = this.getAttribute("data-hact");
        var id = this.getAttribute("data-id");
        if(act==="toggle"){
          var el = document.getElementById("full_" + id);
          var show = el.style.display !== "none";
          el.style.display = show ? "none" : "block";
          return;
        }
        if(act==="edit") return openEditModal(id);
        if(act==="know") return markKnow(id);
        if(act==="again") return markAgain(id);
        if(act==="del"){
          var ok = confirm("确定删除这条记录？删除后无法恢复（除非你有备份）。");
          if(!ok) return;

          db.ui.mainByDate = ensurePlainObject(db.ui.mainByDate);
          for(var kk in db.ui.mainByDate){
            if(db.ui.mainByDate.hasOwnProperty(kk) && db.ui.mainByDate[kk] === id){
              delete db.ui.mainByDate[kk];
            }
          }
          if(db.ui.reviewRandomId === id) db.ui.reviewRandomId = null;

          var newArr = [];
          for(var t=0;t<db.records.length;t++){
            if(db.records[t].id !== id) newArr.push(db.records[t]);
          }
          db.records = newArr;
          saveDB(db);
          render();
        }
      };
    }
  }

  function downloadText(filename, text, mime){
    mime = mime || "application/json;charset=utf-8";
    var blob = new Blob([text], {type:mime});
    var a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    try{ URL.revokeObjectURL(a.href); }catch(_){}
  }
  function exportJSON(){
    var payload = { exportedAt: nowTs(), version: db.version || 3, records: db.records, ui: db.ui };
    downloadText("poem-journal-backup_" + dateKey() + ".json", JSON.stringify(payload, null, 2));
  }
  function renderBackup(){
    var total = db.records.length;
    var lastUpdated = "无";
    if(total){
      var max = 0;
      for(var i=0;i<db.records.length;i++){
        var u = db.records[i].updatedAt || 0;
        if(u > max) max = u;
      }
      lastUpdated = new Date(max).toLocaleString();
    }

    left.innerHTML =
      '<div class="cardHead"><h2>备份</h2><div class="sub2">建议定期导出</div></div>' +
      '<div class="hr"></div>' +
      '<div class="meta">当前共有 <b>' + total + '</b> 条记录。最近更新：<b>' + escapeHtml(lastUpdated) + '</b>。</div>' +
      '<div class="hr"></div>' +
      '<div class="row"><button class="btn primary" id="btnExport">导出 JSON 备份</button></div>' +
      '<div class="notice" style="margin-top:12px">导出文件建议保存在网盘或多个位置，防止浏览器清理缓存导致丢失。</div>';

    right.innerHTML =
      '<div class="cardHead"><h2>提示</h2><div class="sub2">使用习惯</div></div>' +
      '<div class="hr"></div>' +
      '<div class="meta">你可以：<br/>1) 每天记录一首诗（可多重点句）；<br/>2) 用“随机复习”快速回顾；<br/>3) 每周导出一次备份。</div>';

    var ex = document.getElementById("btnExport");
    if(ex) ex.onclick = function(){ exportJSON(); };
  }

  function render(){
    setActiveTab();
    if(activeTab==="today") return renderToday();
    if(activeTab==="history") return renderHistory();
    if(activeTab==="backup") return renderBackup();
    return renderToday();
  }

  // 绑定打开弹窗
  btnAddTop.onclick = function(){ openAddModal(); };

  // 首次渲染
  try{ render(); }catch(e){ showFatal(e); }

})();
</script>
</body>
</html>
