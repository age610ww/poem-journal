<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>每日诗词记录 · 主诗 + 随机复习</title>
  <style>
    :root{
      --page:#ffffff;

      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;

      --accent:#2563eb;
      --accent-soft: rgba(37,99,235,.10);

      --good:#10b981;
      --warn:#f59e0b;
      --danger:#ef4444;

      --radius-lg:18px;
      --radius-md:14px;
      --radius-sm:12px;

      --shadow-sm: 0 6px 18px rgba(17,24,39,.06);
      --shadow-md: 0 14px 36px rgba(17,24,39,.10);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--page);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI",
        "PingFang SC","Hiragino Sans GB","Microsoft YaHei", Arial;
      letter-spacing: .1px;
    }

    .topbar{
      position:sticky;
      top:0;
      z-index:10;
      background:rgba(255,255,255,.92);
      border-bottom:1px solid rgba(229,231,235,.75);
    }
    .topbar-inner{
      max-width:1120px;
      margin:0 auto;
      padding:14px 16px;
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:240px;
    }
    .brand h1{
      margin:0;
      font-size:18px;
      font-weight:800;
      letter-spacing:.3px;
    }
    .brand .sub{
      margin:0;
      color:var(--muted);
      font-size:12px;
      line-height:1.5;
    }

    .tabs{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .seg{
      display:flex;
      gap:0;
      border:1px solid var(--border);
      border-radius:999px;
      overflow:hidden;
      background:#fff;
      box-shadow: var(--shadow-sm);
    }
    .tab{
      border:none;
      background:transparent;
      color:var(--muted);
      padding:10px 14px;
      cursor:pointer;
      font-size:13px;
      font-weight:650;
      transition: background .18s ease, color .18s ease;
      outline:none;
    }
    .tab:hover{background:rgba(17,24,39,.03); color:var(--text);}
    .tab.active{
      background:var(--accent-soft);
      color:var(--accent);
    }

    .btn{
      appearance:none;
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-size:14px;
      font-weight:650;
      transition: transform .06s ease, box-shadow .18s ease, background .18s ease;
      box-shadow: var(--shadow-sm);
    }
    .btn:hover{ box-shadow: var(--shadow-md); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: rgba(37,99,235,.35);
      background: linear-gradient(180deg, rgba(37,99,235,.95), rgba(37,99,235,.85));
      color:#fff;
    }
    .btn.ghost{
      background:transparent;
      box-shadow:none;
    }
    .btn.small{
      padding:7px 10px;
      font-size:12px;
      border-radius:10px;
      box-shadow:none;
    }
    .btn.good{ border-color: rgba(16,185,129,.35); background: rgba(16,185,129,.10); box-shadow:none; }
    .btn.warn{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); box-shadow:none; }
    .btn.danger{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); box-shadow:none; }

    .wrap{
      max-width:1120px;
      margin:18px auto 34px;
      padding:0 16px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.35fr .65fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr;}
    }

    .card{
      background:#fff;
      border:1px solid rgba(229,231,235,.9);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      padding:14px;
    }
    .cardHead{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      padding:2px 2px 10px;
    }
    .cardHead h2{
      margin:0;
      font-size:16px;
      font-weight:850;
    }
    .cardHead .sub2{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }
    .hr{
      height:1px;
      background: rgba(229,231,235,.9);
      margin:12px 0;
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .col{display:flex;flex-direction:column;gap:10px;}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border:1px solid rgba(229,231,235,.95);
      border-radius:999px;
      background: rgba(17,24,39,.02);
      font-size:12px;
      color:var(--muted);
      font-weight:650;
    }
    .meta{color:var(--muted);font-size:13px;line-height:1.7}
    .notice{
      color:#92400e;
      background:rgba(245,158,11,.10);
      border:1px solid rgba(245,158,11,.25);
      padding:12px 12px;
      border-radius:14px;
      font-size:13px;
      line-height:1.7;
    }

    label{font-size:12px;color:var(--muted);font-weight:650;}
    input[type="text"], textarea, select, input[type="date"]{
      background:#fff;
      color:var(--text);
      border:1px solid rgba(229,231,235,.95);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
    }
    textarea{
      width:100%;
      min-height:150px;
      resize:vertical;
      line-height:1.7;
    }
    select{min-width:260px}

    .poemCard{
      margin-top:10px;
      background: linear-gradient(180deg, rgba(17,24,39,.02), rgba(17,24,39,0));
      border:1px solid rgba(229,231,235,.95);
      border-radius: var(--radius-md);
      padding:12px;
    }
    .poemTitle{
      margin:0;
      font-size:22px;
      font-weight:900;
      letter-spacing:.3px;
      line-height:1.25;
    }
    .poemMeta{
      margin-top:6px;
      color:var(--muted);
      font-size:12px;
      line-height:1.6;
    }
    .poemLines{
      margin-top:12px;
      padding:6px 4px 2px;
    }
    .poemLine{
      padding:6px 0;
      line-height:2.0;
      font-size:16px;
      letter-spacing:.2px;
    }
    .poemLine.highlight{
      color:var(--accent);
      font-weight:900;
      background:transparent;
    }
    .poemActions{
      margin-top:12px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
      flex-wrap:wrap;
    }

    details{
      border:1px solid rgba(229,231,235,.95);
      border-radius: var(--radius-md);
      background:#fff;
      box-shadow: var(--shadow-sm);
      overflow:hidden;
    }
    summary{
      cursor:pointer;
      padding:12px;
      list-style:none;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      background: rgba(17,24,39,.02);
    }
    summary::-webkit-details-marker{display:none}
    .groupBody{padding:0 12px 12px}
    .miniRow{
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
      padding:12px 0;
      border-top:1px solid rgba(229,231,235,.7);
    }
    .miniRow:first-child{border-top:none}
    .miniRow .left{min-width:260px}
    .miniRow .right{display:flex;gap:8px;flex-wrap:wrap}
    .kbd{
      border:1px solid rgba(229,231,235,.95);
      background:#fff;
      padding:2px 6px;
      border-radius:8px;
      font-size:12px;
      color:var(--muted)
    }

    .modalMask{
      position:fixed;
      inset:0;
      background:rgba(17,24,39,.50);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:20;
    }
    .modal{
      width:min(940px, 100%);
      background:#fff;
      border:1px solid rgba(229,231,235,.95);
      border-radius: 18px;
      padding:14px;
      box-shadow: 0 24px 70px rgba(17,24,39,.25);
    }
    .split{display:grid;grid-template-columns: 1fr 1fr;gap:12px;}
    @media (max-width: 980px){ .split{grid-template-columns:1fr;} }

    .linePicker{
      border:1px solid rgba(229,231,235,.95);
      border-radius: 14px;
      background:#fff;
      padding:10px;
      max-height:340px;
      overflow:auto;
    }
    .pickLine{
      padding:8px 10px;
      border-radius: 12px;
      cursor:pointer;
      border:1px solid transparent;
      line-height:1.6;
      display:flex;
      gap:10px;
    }
    .pickLine:hover{background:rgba(17,24,39,.03)}
    .pickLine.active{
      border-color: rgba(37,99,235,.35);
      color: var(--accent);
      font-weight: 900;
      background: rgba(37,99,235,.06);
    }

    .footNote{font-size:12px;color:var(--muted);line-height:1.7}
    .switch{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid rgba(229,231,235,.95);
      border-radius: 12px;
      background:#fff;
      color:var(--muted);
      font-size:13px;
      font-weight:650;
    }
    .switch input{transform:scale(1.12)}

    noscript{
      display:block;
      max-width:1120px;
      margin:18px auto;
      padding:12px 16px;
      border:1px solid rgba(239,68,68,.25);
      background: rgba(239,68,68,.08);
      border-radius:14px;
      color:#7f1d1d;
      font-size:13px;
      line-height:1.7;
    }
  </style>
</head>

<body>
  <noscript>检测到浏览器禁用了 JavaScript，因此页面无法渲染内容。请启用 JavaScript 后刷新。</noscript>

  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <h1>每日诗词记录</h1>
        <p class="sub">记录保存在本地浏览器；建议定期导出 JSON 备份。</p>
      </div>
      <div class="tabs">
        <div class="seg">
          <button class="tab active" id="tabToday">今日</button>
          <button class="tab" id="tabHistory">历史</button>
          <button class="tab" id="tabBackup">备份</button>
        </div>
        <button class="btn primary" id="btnAddTop">+ 记录诗词</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <div class="card" id="leftCard"></div>
      <div class="card" id="rightCard"></div>
    </div>
  </div>

  <div class="modalMask" id="modalMask" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="cardHead">
        <h2 id="modalTitle">记录诗词</h2>
        <div class="row">
          <button class="btn ghost small" id="btnCloseModal">关闭</button>
        </div>
      </div>
      <div class="hr"></div>

      <div class="split">
        <div class="col">
          <div class="row">
            <div style="flex:1">
              <label>日期（默认今天，可改）</label>
              <input type="date" id="fDate" />
            </div>
            <div style="flex:1">
              <label>题目（必填，用于全库查重）</label>
              <input type="text" id="fTitle" placeholder="如：静夜思" />
            </div>
          </div>

          <div class="row">
            <div style="flex:1">
              <label>作者（可选）</label>
              <input type="text" id="fAuthor" placeholder="如：李白" />
            </div>
            <div style="flex:1">
              <label>朝代（可选）</label>
              <input type="text" id="fDynasty" placeholder="如：唐" />
            </div>
          </div>

          <div class="row" style="justify-content:space-between">
            <div class="switch">
              <input type="checkbox" id="fSetAsMain" />
              <label for="fSetAsMain" style="margin:0;cursor:pointer">设为当日主诗</label>
            </div>
            <div class="meta">主诗可指向历史记录（不必是当天新记录）。</div>
          </div>

          <div>
            <label>诗词正文（整首，建议每行一句；粘贴即可）</label>
            <textarea id="fPoem" placeholder="床前明月光&#10;疑是地上霜&#10;举头望明月&#10;低头思故乡"></textarea>
            <div class="footNote">会自动去掉空行。重点句仅“彩色 + 加粗”，不加底色。</div>
          </div>

          <div>
            <label>备注（可选）</label>
            <input type="text" id="fNote" placeholder="如：今天卡在第二句 / 想重点复习第三句" />
          </div>

          <div class="row" style="justify-content:flex-end">
            <button class="btn danger small" id="btnDeleteInModal" style="display:none">删除</button>
            <button class="btn primary" id="btnSave">保存</button>
          </div>
        </div>

        <div>
          <div class="row" style="justify-content:space-between">
            <div class="pill">选择重点句（可多选）</div>
            <div class="meta">已选 <span id="selCount">0</span> 行（至少 1 行）</div>
          </div>
          <div class="linePicker" id="linePicker">
            <div class="meta">先在左侧输入正文，这里会出现逐行预览。</div>
          </div>
          <div class="row" style="justify-content:flex-end;margin-top:10px">
            <button class="btn small ghost" id="btnClearSel">清空选择</button>
            <button class="btn small ghost" id="btnSelectAll">全选</button>
          </div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="footNote">
        说明：只记录诗词（整首 + 若干重点句）。全库按“题目”去重；若重复可选择编辑旧记录或直接设为当日主诗。
      </div>
    </div>
  </div>

<script>
(function(){
  // --------- 兜底：任何错误直接显示在页面，不让“空白” ---------
  function escapeHtml(s){
    return String(s)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }
  function showFatal(err){
    var msg = (err && err.stack) ? err.stack : String(err);
    document.body.innerHTML =
      '<div style="max-width:900px;margin:40px auto;padding:16px;font-family:system-ui,-apple-system,Segoe UI,PingFang SC,Microsoft YaHei,Arial;">' +
      '<h2 style="margin:0 0 12px 0;">页面脚本出错（已停止渲染）</h2>' +
      '<div style="color:#6b7280;line-height:1.6;margin-bottom:12px;">' +
      '请把下面错误信息截图发我，我能立刻定位原因（常见是浏览器兼容或复制不完整）。' +
      '</div>' +
      '<pre style="white-space:pre-wrap;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;line-height:1.5;">' +
      escapeHtml(msg) +
      '</pre>' +
      '</div>';
  }
  if (window.addEventListener){
    window.addEventListener('error', function(e){
      try{ showFatal(e.error || e.message || e); }catch(_){}
    });
  }

  // --------- 工具函数（ES5 兼容） ---------
  function nowTs(){ return new Date().getTime(); }
  function pad2(n){ return (n<10 ? "0" : "") + n; }
  function dateKey(d){
    d = d || new Date();
    return d.getFullYear() + "-" + pad2(d.getMonth()+1) + "-" + pad2(d.getDate());
  }
  function yesterdayKey(){
    var d = new Date();
    d.setDate(d.getDate() - 1);
    return dateKey(d);
  }
  function isArray(x){ return Object.prototype.toString.call(x) === "[object Array]"; }
  function ensurePlainObject(x){
    return (x && typeof x === "object" && !isArray(x)) ? x : {};
  }
  function safeLines(lines){
    if(!isArray(lines)) return [];
    var out = [];
    for(var i=0;i<lines.length;i++){
      var s = String(lines[i] || "").replace(/^\s+|\s+$/g,"");
      if(s) out.push(s);
    }
    return out;
  }
  function normTitle(t){
    return String(t || "").replace(/^\s+|\s+$/g,"").replace(/\s+/g," ");
  }
  function uuid(){
    try{
      if(window.crypto && crypto.randomUUID) return crypto.randomUUID();
    }catch(_){}
    return "id_" + Math.random().toString(16).slice(2) + "_" + nowTs();
  }

  // --------- 存储 ---------
  var LS_KEY = "poem_journal_v2";

  function saveDB(db){
    try{ localStorage.setItem(LS_KEY, JSON.stringify(db)); }catch(e){}
  }

  function migrateDB(db){
    db = db || {};
    db.version = db.version || 3;
    db.records = isArray(db.records) ? db.records : [];
    db.ui = ensurePlainObject(db.ui);

    db.ui.activeTab = db.ui.activeTab || "today";
    db.ui.selectedDate = db.ui.selectedDate || yesterdayKey();
    db.ui.selectedRecordByDate = ensurePlainObject(db.ui.selectedRecordByDate);
    db.ui.mainByDate = ensurePlainObject(db.ui.mainByDate);
    db.ui.historyQuery = (db.ui.historyQuery != null) ? String(db.ui.historyQuery) : "";
    db.ui.reviewRandomId = db.ui.reviewRandomId || null;

    for(var i=0;i<db.records.length;i++){
      var r = db.records[i];
      if(!r.id) r.id = uuid();
      r.createdDate = r.createdDate || dateKey();
      r.createdAt = r.createdAt || nowTs();
      r.updatedAt = r.updatedAt || r.createdAt;

      r.poemLines = safeLines(r.poemLines || []);
      if(r.poemLines.length === 0) r.poemLines = [""];

      // 兼容老字段 highlightIndex -> highlightIndices
      if(!isArray(r.highlightIndices)){
        if(typeof r.highlightIndex === "number") r.highlightIndices = [r.highlightIndex];
        else r.highlightIndices = [0];
      }

      // 修正索引范围并去重
      var maxIdx = Math.max(0, r.poemLines.length - 1);
      var seen = {};
      var fixed = [];
      for(var j=0;j<r.highlightIndices.length;j++){
        var idx = parseInt(r.highlightIndices[j],10);
        if(isNaN(idx)) continue;
        if(idx<0) idx=0;
        if(idx>maxIdx) idx=maxIdx;
        if(!seen[idx]){
          seen[idx]=true;
          fixed.push(idx);
        }
      }
      fixed.sort(function(a,b){return a-b;});
      if(fixed.length === 0) fixed = [0];
      r.highlightIndices = fixed;

      if(typeof r.lastReviewedAt === "undefined") r.lastReviewedAt = null;
      if(typeof r.reviewCount === "undefined") r.reviewCount = 0;
      if(typeof r.nextDueAt === "undefined") r.nextDueAt = null;
    }
    saveDB(db);
    return db;
  }

  function loadDB(){
    try{
      var raw = localStorage.getItem(LS_KEY);
      if(raw){
        var db = JSON.parse(raw);
        return migrateDB(db);
      }
    }catch(e){}
    // 兼容 v1
    try{
      var raw1 = localStorage.getItem("poem_journal_v1");
      if(raw1){
        var old = JSON.parse(raw1);
        if(old && isArray(old.records)){
          var db2 = { version:3, records: old.records, ui: old.ui || {} };
          return migrateDB(db2);
        }
      }
    }catch(e){}
    return migrateDB({ version:3, records:[], ui:{} });
  }

  var db = loadDB();

  // --------- 复习逻辑 ---------
  var REVIEW_INTERVAL_DAYS = [1,3,7,14,30,60,120];

  function nextDueFrom(count, fromTs){
    var idx = count-1;
    if(idx<0) idx=0;
    if(idx>REVIEW_INTERVAL_DAYS.length-1) idx=REVIEW_INTERVAL_DAYS.length-1;
    return fromTs + REVIEW_INTERVAL_DAYS[idx]*24*60*60*1000;
  }

  function isDue(rec, now){
    now = now || nowTs();
    if(rec.nextDueAt != null) return now >= rec.nextDueAt;
    if(!rec.lastReviewedAt) return true;
    if(!rec.reviewCount || rec.reviewCount<=0) return now >= (rec.lastReviewedAt + 24*60*60*1000);
    return now >= nextDueFrom(rec.reviewCount, rec.lastReviewedAt);
  }

  function markKnow(recId){
    var rec = findRecord(recId);
    if(!rec) return;
    var t = nowTs();
    rec.reviewCount = (rec.reviewCount || 0) + 1;
    rec.lastReviewedAt = t;
    rec.nextDueAt = nextDueFrom(rec.reviewCount, t);
    rec.updatedAt = t;
    saveDB(db);
    render();
  }
  function markAgain(recId){
    var rec = findRecord(recId);
    if(!rec) return;
    var t = nowTs();
    rec.lastReviewedAt = t;
    rec.nextDueAt = t + 24*60*60*1000;
    rec.updatedAt = t;
    saveDB(db);
    render();
  }

  // --------- 查找/辅助 ---------
  function findRecord(id){
    for(var i=0;i<db.records.length;i++){
      if(db.records[i].id === id) return db.records[i];
    }
    return null;
  }

  function recTitle(rec){
    var t = rec.title ? String(rec.title).replace(/^\s+|\s+$/g,"") : "";
    var a = rec.author ? String(rec.author).replace(/^\s+|\s+$/g,"") : "";
    var d = rec.dynasty ? String(rec.dynasty).replace(/^\s+|\s+$/g,"") : "";
    var left = t ? "《" + t + "》" : "（未命名）";
    var right = [];
    if(d) right.push(d);
    if(a) right.push(a);
    return right.length ? (left + " · " + right.join("·")) : left;
  }

  function daysAgo(ts){
    if(!ts) return "未复习过";
    var now = new Date();
    var d = new Date(ts);
    var n0 = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
    var d0 = new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime();
    var diff = Math.round((n0 - d0) / (24*60*60*1000));
    if(diff <= 0) return "今天";
    if(diff === 1) return "1 天前";
    return diff + " 天前";
  }

  function getRecordsByDate(d){
    var out = [];
    for(var i=0;i<db.records.length;i++){
      if(db.records[i].createdDate === d) out.push(db.records[i]);
    }
    out.sort(function(a,b){ return (b.createdAt||0) - (a.createdAt||0); });
    return out;
  }

  function setMainForDate(d, recId){
    db.ui.mainByDate = ensurePlainObject(db.ui.mainByDate);
    db.ui.mainByDate[d] = recId;
    saveDB(db);
  }

  function getMainRecordForDate(d){
    var recs = getRecordsByDate(d);

    db.ui.mainByDate = ensurePlainObject(db.ui.mainByDate);
    db.ui.selectedRecordByDate = ensurePlainObject(db.ui.selectedRecordByDate);

    var mainId = db.ui.mainByDate[d] || null;
    var main = mainId ? findRecord(mainId) : null;

    var selectedId = db.ui.selectedRecordByDate[d] || null;
    var selected = selectedId ? findRecord(selectedId) : null;

    var active = selected || main || (recs.length ? recs[0] : null);

    // options：main + 当天记录去重
    var options = [];
    var seen = {};
    if(main){ options.push(main); seen[main.id]=true; }
    for(var i=0;i<recs.length;i++){
      if(!seen[recs[i].id]){
        options.push(recs[i]);
        seen[recs[i].id]=true;
      }
    }
    return { recs:recs, main:main, active:active, options:options };
  }

  function chooseRandom(arr, excludeId){
    if(!arr || !arr.length) return null;
    if(arr.length === 1) return arr[0];
    var pool = [];
    for(var i=0;i<arr.length;i++){
      if(arr[i].id !== excludeId) pool.push(arr[i]);
    }
    if(!pool.length) pool = arr.slice(0);
    var idx = Math.floor(Math.random() * pool.length);
    return pool[idx];
  }

  function groupByDate(records){
    var groups = {}; // date -> array
    for(var i=0
